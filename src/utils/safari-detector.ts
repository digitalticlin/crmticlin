// Detecta Safari e aplica classes espec√≠ficas para fixes
export const applySafariFixesIfNeeded = () => {
  // Detecta Safari com melhor precis√£o
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  const isWebKit = 'WebkitAppearance' in document.documentElement.style;
  const isMacOS = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

  // Detec√ß√£o abrangente de vers√µes macOS (do mais antigo ao mais novo)
  const macOSVersion = detectMacOSVersion();
  const safariVersion = detectSafariVersion();

  // Adiciona classes ao body para targeting CSS espec√≠fico
  if (isSafari || isWebKit) {
    document.body.classList.add('webkit-browser');

    if (isSafari) {
      document.body.classList.add('safari-browser');
    }

    if (isMacOS) {
      document.body.classList.add('macos-system');

      // Adiciona classes espec√≠ficas por vers√£o do macOS
      if (macOSVersion) {
        document.body.classList.add(`macos-${macOSVersion.name}`);
        document.body.classList.add(`macos-version-${macOSVersion.major}`);

        // Casos espec√≠ficos problem√°ticos
        if (macOSVersion.hasKnownBackdropIssues) {
          document.body.classList.add('macos-backdrop-issues');
        }
      }

      // Adiciona classes espec√≠ficas por vers√£o do Safari
      if (safariVersion) {
        document.body.classList.add(`safari-version-${safariVersion.major}`);
        if (safariVersion.hasKnownModalIssues) {
          document.body.classList.add('safari-modal-issues');
        }
      }
    }

    if (isIOS) {
      document.body.classList.add('ios-system');
    }

    // Log detalhado para debug - SISTEMA OPERACIONAL E NAVEGADOR
    console.group('üîç [SISTEMA OPERACIONAL DEBUG]');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üì± Sistema Operacional:', {
      platform: navigator.platform,
      userAgent: navigator.userAgent,
      vendor: navigator.vendor,
      appVersion: navigator.appVersion
    });
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üåê Detec√ß√£o de Navegador:', {
      isSafari,
      isWebKit,
      isMacOS,
      isIOS,
      isChrome: /Chrome/.test(navigator.userAgent),
      isFirefox: /Firefox/.test(navigator.userAgent),
      isEdge: /Edg/.test(navigator.userAgent)
    });
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üçé macOS Version:', macOSVersion);
    console.log('üß≠ Safari Version:', safariVersion);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üé® Classes CSS aplicadas ao body:',
      Array.from(document.body.classList)
    );
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.groupEnd();

    // Aplica fix espec√≠fico para backdrop-filter se necess√°rio
    testBackdropFilterSupport();
  }
};

// Detecta vers√£o espec√≠fica do macOS
const detectMacOSVersion = () => {
  const userAgent = navigator.userAgent;

  // Mapeamento de vers√µes do macOS (do mais antigo ao mais novo)
  const macOSVersions = [
    { regex: /Mac OS X 10_9/, name: 'mavericks', major: 9, hasKnownBackdropIssues: true },
    { regex: /Mac OS X 10_10/, name: 'yosemite', major: 10, hasKnownBackdropIssues: true },
    { regex: /Mac OS X 10_11/, name: 'el-capitan', major: 11, hasKnownBackdropIssues: true },
    { regex: /Mac OS X 10_12/, name: 'sierra', major: 12, hasKnownBackdropIssues: true },
    { regex: /Mac OS X 10_13/, name: 'high-sierra', major: 13, hasKnownBackdropIssues: true },
    { regex: /Mac OS X 10_14/, name: 'mojave', major: 14, hasKnownBackdropIssues: true },
    { regex: /Mac OS X 10_15/, name: 'catalina', major: 15, hasKnownBackdropIssues: true },
    { regex: /Mac OS X 10_16|macOS 11/, name: 'big-sur', major: 16, hasKnownBackdropIssues: true },
    { regex: /macOS 12/, name: 'monterey', major: 17, hasKnownBackdropIssues: true },
    { regex: /macOS 13/, name: 'ventura', major: 18, hasKnownBackdropIssues: true },
    { regex: /macOS 14/, name: 'sonoma', major: 19, hasKnownBackdropIssues: true },
    { regex: /macOS 15/, name: 'sequoia', major: 20, hasKnownBackdropIssues: true },
  ];

  for (const version of macOSVersions) {
    if (version.regex.test(userAgent)) {
      return version;
    }
  }

  // Fallback para vers√µes n√£o identificadas (assumir problemas)
  if (navigator.platform.toUpperCase().indexOf('MAC') >= 0) {
    return { name: 'unknown', major: 0, hasKnownBackdropIssues: true };
  }

  return null;
};

// Detecta vers√£o espec√≠fica do Safari
const detectSafariVersion = () => {
  const userAgent = navigator.userAgent;
  const versionMatch = userAgent.match(/Version\/(\d+)\.(\d+)/);

  if (versionMatch) {
    const major = parseInt(versionMatch[1]);
    const minor = parseInt(versionMatch[2]);

    // Vers√µes do Safari com problemas conhecidos de modal
    const hasKnownModalIssues = major >= 14; // Safari 14+ tem problemas com transform + backdrop-filter

    return {
      major,
      minor,
      hasKnownModalIssues
    };
  }

  return null;
};

// Testa suporte real ao backdrop-filter
const testBackdropFilterSupport = () => {
  // Cria elemento de teste
  const testEl = document.createElement('div');
  testEl.style.cssText = 'backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px);';

  // Verifica se o estilo foi aplicado
  const supportsBackdrop = testEl.style.backdropFilter !== undefined ||
                          testEl.style.webkitBackdropFilter !== undefined;

  console.group('üé® [TESTE BACKDROP-FILTER]');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('üîç Suporte CSS backdrop-filter:', {
    supportsBackdrop,
    'testEl.style.backdropFilter': testEl.style.backdropFilter,
    'testEl.style.webkitBackdropFilter': testEl.style.webkitBackdropFilter
  });

  if (!supportsBackdrop) {
    document.body.classList.add('no-backdrop-support');
    console.error('‚ùå backdrop-filter N√ÉO suportado - aplicando fallbacks');
    console.log('üõ†Ô∏è Classe aplicada: no-backdrop-support');
  } else {
    console.log('‚úÖ backdrop-filter SUPORTADO pelo CSS');
    console.log('üîÑ Testando renderiza√ß√£o real...');
    // Testa se funciona corretamente (Safari √†s vezes aceita mas n√£o renderiza)
    testBackdropRendering();
  }
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.groupEnd();
};

// Testa se o backdrop-filter est√° renderizando corretamente
const testBackdropRendering = () => {
  const testContainer = document.createElement('div');
  testContainer.style.cssText = `
    position: fixed;
    top: -100px;
    left: -100px;
    width: 50px;
    height: 50px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.1);
  `;

  document.body.appendChild(testContainer);

  // Verifica ap√≥s um frame de renderiza√ß√£o
  requestAnimationFrame(() => {
    const computed = window.getComputedStyle(testContainer);
    const hasBackdrop = computed.backdropFilter !== 'none' ||
                       computed.webkitBackdropFilter !== 'none';

    console.group('üé≠ [TESTE RENDERIZA√á√ÉO BACKDROP]');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üñºÔ∏è Computed Style do elemento de teste:', {
      backdropFilter: computed.backdropFilter,
      webkitBackdropFilter: computed.webkitBackdropFilter,
      backgroundColor: computed.backgroundColor,
      hasBackdrop
    });

    if (!hasBackdrop) {
      document.body.classList.add('backdrop-render-fail');
      console.error('‚ùå FALHA CR√çTICA: backdrop-filter aceito mas N√ÉO RENDERIZA!');
      console.log('üõ†Ô∏è Classe aplicada: backdrop-render-fail');
      console.log('‚ö†Ô∏è Cards podem aparecer 100% brancos sem transpar√™ncia');
      console.log('üí° Aplicando fallbacks pesados com backgrounds s√≥lidos...');
    } else {
      console.log('‚úÖ backdrop-filter RENDERIZA CORRETAMENTE');
    }

    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.groupEnd();

    // Remove elemento de teste
    document.body.removeChild(testContainer);
  });
};

// Fun√ß√£o para aplicar fixes espec√≠ficos em elementos problem√°ticos
export const fixSafariElement = (element: HTMLElement) => {
  if (!element) return;

  const isSafari = document.body.classList.contains('safari-browser');
  const hasBackdropIssue = document.body.classList.contains('backdrop-render-fail');

  if (isSafari || hasBackdropIssue) {
    // For√ßa repaint/reflow para elementos com backdrop-filter
    element.style.transform = 'translateZ(0)';
    element.style.webkitTransform = 'translateZ(0)';
    element.style.willChange = 'transform';

    // Para elementos cr√≠ticos, aplica background s√≥lido como fallback
    if (hasBackdropIssue) {
      const currentBg = window.getComputedStyle(element).backgroundColor;
      if (currentBg.includes('rgba') && currentBg.includes('0.')) {
        // Aumenta opacidade do background
        element.style.backgroundColor = currentBg.replace(/0\.\d+\)/, '0.95)');
      }
    }
  }
};

// Fun√ß√£o de debug para verificar elementos com backdrop na p√°gina
export const debugBackdropElements = () => {
  console.group('üîç [DEBUG ELEMENTOS BACKDROP]');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

  // Busca todos os elementos com classes backdrop
  const backdropElements = document.querySelectorAll('[class*="backdrop-blur"]');

  console.log(`üìä Total de elementos com backdrop encontrados: ${backdropElements.length}`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

  backdropElements.forEach((el, index) => {
    const computed = window.getComputedStyle(el as HTMLElement);
    const classList = Array.from((el as HTMLElement).classList);

    console.group(`Elemento ${index + 1}/${backdropElements.length}`);
    console.log('üè∑Ô∏è Classes:', classList.filter(c => c.includes('backdrop')));
    console.log('üé® Computed Styles:', {
      backdropFilter: computed.backdropFilter,
      webkitBackdropFilter: computed.webkitBackdropFilter,
      backgroundColor: computed.backgroundColor,
      opacity: computed.opacity,
      display: computed.display,
      visibility: computed.visibility
    });
    console.log('üìê Dimens√µes:', {
      width: computed.width,
      height: computed.height,
      position: computed.position
    });
    console.log('üîó Elemento:', el);
    console.groupEnd();
  });

  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.groupEnd();
};

// Fun√ß√£o para verificar quais regras CSS est√£o sendo aplicadas
export const debugCSSRules = () => {
  console.group('üìú [DEBUG REGRAS CSS SAFARI]');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

  const testElement = document.createElement('div');
  testElement.className = 'backdrop-blur-md';
  testElement.style.cssText = 'position: fixed; top: -100px; left: -100px; width: 50px; height: 50px;';
  document.body.appendChild(testElement);

  const computed = window.getComputedStyle(testElement);

  console.log('üß™ Teste elemento .backdrop-blur-md:', {
    backdropFilter: computed.backdropFilter,
    webkitBackdropFilter: computed.webkitBackdropFilter,
    backgroundColor: computed.backgroundColor,
    border: computed.border
  });

  // Testa com classes do body
  const bodyClasses = Array.from(document.body.classList);
  console.log('üè∑Ô∏è Classes no body:', bodyClasses);

  console.log('‚úÖ Regras que DEVEM estar ativas:');
  if (bodyClasses.includes('macos-system')) {
    console.log('  - body.macos-system .backdrop-blur-md { background-color: rgba(255,255,255,0.95) }');
  }
  if (bodyClasses.includes('safari-browser')) {
    console.log('  - body.safari-browser .backdrop-blur-md { background-color: rgba(255,255,255,0.95) }');
  }
  if (bodyClasses.includes('backdrop-render-fail')) {
    console.log('  - body.backdrop-render-fail [class*="backdrop-blur"] { background-color: rgba(255,255,255,0.98) }');
    console.warn('  ‚ö†Ô∏è ATEN√á√ÉO: backdrop-filter desabilitado devido a falha na renderiza√ß√£o!');
  }
  if (bodyClasses.includes('no-backdrop-support')) {
    console.log('  - body.no-backdrop-support [class*="backdrop-blur"] { background-color: rgba(255,255,255,0.98) }');
    console.warn('  ‚ö†Ô∏è ATEN√á√ÉO: backdrop-filter n√£o suportado!');
  }

  document.body.removeChild(testElement);

  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.groupEnd();
};

// Exp√µe fun√ß√µes de debug globalmente
if (typeof window !== 'undefined') {
  (window as any).debugBackdropElements = debugBackdropElements;
  (window as any).debugCSSRules = debugCSSRules;
  console.log('‚úÖ Fun√ß√µes de debug dispon√≠veis:');
  console.log('  - window.debugBackdropElements()');
  console.log('  - window.debugCSSRules()');
}

// Auto-executa ao importar
if (typeof window !== 'undefined') {
  // Executa quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applySafariFixesIfNeeded);
  } else {
    applySafariFixesIfNeeded();
  }

  // Adiciona listener para executar debug ap√≥s carregamento completo
  window.addEventListener('load', () => {
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üé¨ P√°gina completamente carregada - executando debug final...');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

    // Aguarda mais um frame para garantir que tudo foi renderizado
    setTimeout(() => {
      debugBackdropElements();
      debugCSSRules();

      // Resume das classes aplicadas
      console.group('üìã [RESUMO FINAL]');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üé® Classes CSS finais no body:', Array.from(document.body.classList));
      console.log('üåç User Agent:', navigator.userAgent);
      console.log('üíª Platform:', navigator.platform);
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üí° Para re-executar debug:');
      console.log('  - window.debugBackdropElements()');
      console.log('  - window.debugCSSRules()');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.groupEnd();
    }, 500);
  });
}