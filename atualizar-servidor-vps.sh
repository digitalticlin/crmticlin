#!/bin/bash
echo "üîß ATUALIZANDO SERVIDOR PUPPETEER NA VPS"
echo "========================================"
echo ""
echo "üìã COMANDOS PARA EXECUTAR:"
echo ""
echo "1Ô∏è‚É£ Conectar na VPS:"
echo "   ssh root@31.97.163.57"
echo ""
echo "2Ô∏è‚É£ Navegar para o diret√≥rio:"
echo "   cd /opt/whatsapp-puppeteer"
echo ""
echo "3Ô∏è‚É£ Fazer backup do arquivo atual:"
echo "   cp server.js server.js.backup-$(date +%Y%m%d-%H%M%S)"
echo ""
echo "4Ô∏è‚É£ Parar servidor atual:"
echo "   pkill -f 'node server.js'"
echo ""
echo "5Ô∏è‚É£ Criar arquivo otimizado (cole o conte√∫do do server-puppeteer-optimized.js):"
echo "   nano server-optimized.js"
echo ""
echo "6Ô∏è‚É£ Testar o novo servidor:"
echo "   node server-optimized.js"
echo ""
echo "7Ô∏è‚É£ Se funcionar, substituir o original:"
echo "   mv server.js server.js.old"
echo "   mv server-optimized.js server.js"
echo ""
echo "8Ô∏è‚É£ Iniciar servidor em background:"
echo "   nohup node server.js > server.log 2>&1 &"
echo ""
echo "9Ô∏è‚É£ Verificar se est√° rodando:"
echo "   curl http://localhost:3001/health"
echo ""
echo "üîü Testar health check externo:"
echo "   curl http://31.97.163.57:3001/health"
echo ""
echo "üìä TESTES DE VALIDA√á√ÉO:"
echo ""
echo "A) Testar cria√ß√£o de inst√¢ncia:"
echo "   curl -X POST http://31.97.163.57:3001/create-instance \\"
echo "        -H 'Authorization: Bearer 8bb0c4f8a89d254783d693050ecd7ff4878534f46a87ece12b24f506548ce430' \\"
echo "        -H 'Content-Type: application/json' \\"
echo "        -d '{\"instanceId\": \"test_$(date +%s)\", \"webhookUrl\": \"https://rhjgagzstjzynvrakdyj.supabase.co/functions/v1/whatsapp_chat_import\"}'"
echo ""
echo "B) Verificar logs em tempo real:"
echo "   tail -f server.log"
echo ""
echo "C) Verificar sess√µes ativas:"
echo "   curl -H 'Authorization: Bearer 8bb0c4f8a89d254783d693050ecd7ff4878534f46a87ece12b24f506548ce430' \\"
echo "        http://31.97.163.57:3001/sessions"
echo ""
echo "‚úÖ INDICADORES DE SUCESSO:"
echo "   - Health check retorna 'webhook_timing_fix: true'"
echo "   - Health check retorna 'qr_validation_enabled: true'"
echo "   - Health check retorna 'version: 2.0-OPTIMIZED'"
echo "   - Logs mostram 'QR Code V√ÅLIDO confirmado para webhook'"
echo "   - Webhook s√≥ √© enviado quando status = 'qr_ready'" 