#!/bin/bash

# üéØ OTIMIZAR PROCESSAMENTO DE N√öMEROS @lid
echo "üéØ OTIMIZANDO PROCESSAMENTO DE N√öMEROS @lid"
echo "Data: $(date)"
echo "================================================="

VPS_SERVER="root@31.97.163.57"
VPS_PATH="/root/whatsapp-server"

echo ""
echo "üîç 1. VERIFICANDO PROCESSAMENTO @lid ATUAL"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üìä Status do sistema:'
pm2 list | grep whatsapp-server

echo ''
echo 'üîç Procurando c√≥digo atual de processamento @lid:'
find . -name '*.js' -not -path './node_modules/*' -exec grep -l '@lid' {} \; | head -5

echo ''
echo 'üìã Verificando n√∫meros @lid em logs recentes:'
pm2 logs whatsapp-server --lines 20 --nostream | grep '@lid' | tail -5 || echo 'Nenhum @lid nos logs recentes'

echo ''
echo 'üéØ Verificando n√∫mero espec√≠fico 274293808169155:'
pm2 logs whatsapp-server --lines 50 --nostream | grep '274293808169155' | tail -3 || echo 'N√∫mero espec√≠fico n√£o encontrado nos logs'
"

echo ""
echo "üíæ 2. BACKUP ANTES DA OTIMIZA√á√ÉO"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üíæ Criando backup de arquivos principais...'

# Backup do connection-manager
if [ -f src/utils/connection-manager.js ]; then
    cp src/utils/connection-manager.js src/utils/connection-manager.js.backup-lid-optimization-$(date +%Y%m%d_%H%M%S)
    echo '‚úÖ Backup connection-manager criado'
fi

# Backup de outros arquivos que podem conter @lid
find . -name '*.js' -not -path './node_modules/*' -exec grep -l '@lid' {} \; | while read file; do
    if [ \"\$file\" != \"./src/utils/connection-manager.js\" ]; then
        cp \"\$file\" \"\$file.backup-lid-$(date +%Y%m%d_%H%M%S)\"
        echo \"üíæ Backup criado: \$file\"
    fi
done

echo 'üìã Backups criados:'
ls -la *.backup-lid-* src/utils/*.backup-lid-* 2>/dev/null | tail -5
"

echo ""
echo "üéØ 3. IMPLEMENTANDO OTIMIZA√á√ÉO DE @lid"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üìù Adicionando classe LidProcessor otimizada...'

# Criar diret√≥rio para utilit√°rios se n√£o existir
mkdir -p src/utils

# Criar processador @lid otimizado
cat > src/utils/lid-processor.js << 'EOF'
// üéØ PROCESSADOR OTIMIZADO DE N√öMEROS @lid
class LidProcessor {
  constructor() {
    console.log('üéØ [LidProcessor] Inicializando processador otimizado de @lid...');
    
    // üìã Mapeamentos conhecidos de @lid para n√∫meros reais
    this.knownLidMappings = new Map([
      // Corre√ß√£o espec√≠fica identificada
      ['274293808169155', '556281242215'], // Brasil
      
      // Padr√µes comuns de @lid
      // Ser√£o adicionados dinamicamente conforme necess√°rio
    ]);
    
    // üìä Cache de processamento para melhor performance
    this.processingCache = new Map();
    
    // üîç Estat√≠sticas de processamento
    this.stats = {
      total: 0,
      corrected: 0,
      cached: 0,
      errors: 0
    };
    
    console.log('‚úÖ [LidProcessor] Inicializado com', this.knownLidMappings.size, 'mapeamentos conhecidos');
  }
  
  // üéØ Processar n√∫mero @lid principal
  processLid(lidNumber) {
    this.stats.total++;
    
    try {
      // Remove @lid suffix se presente
      const cleanNumber = lidNumber.toString().replace(/@lid$/, '');
      
      console.log(\`üîç [LidProcessor] Processando: \${cleanNumber}@lid\`);
      
      // Verificar cache primeiro
      if (this.processingCache.has(cleanNumber)) {
        this.stats.cached++;
        const cached = this.processingCache.get(cleanNumber);
        console.log(\`üíæ [LidProcessor] Cache hit: \${cleanNumber} ‚Üí \${cached}\`);
        return cached;
      }
      
      // Verificar mapeamento conhecido
      if (this.knownLidMappings.has(cleanNumber)) {
        const corrected = this.knownLidMappings.get(cleanNumber);
        this.stats.corrected++;
        
        // Adicionar ao cache
        this.processingCache.set(cleanNumber, corrected);
        
        console.log(\`‚úÖ [LidProcessor] Corre√ß√£o aplicada: \${cleanNumber}@lid ‚Üí \${corrected}\`);
        return corrected;
      }
      
      // Tentar corre√ß√£o inteligente baseada em padr√µes
      const intelligentCorrection = this.attemptIntelligentCorrection(cleanNumber);
      if (intelligentCorrection) {
        this.stats.corrected++;
        
        // Adicionar ao cache e mapeamentos conhecidos
        this.processingCache.set(cleanNumber, intelligentCorrection);
        this.knownLidMappings.set(cleanNumber, intelligentCorrection);
        
        console.log(\`üß† [LidProcessor] Corre√ß√£o inteligente: \${cleanNumber}@lid ‚Üí \${intelligentCorrection}\`);
        return intelligentCorrection;
      }
      
      // Se n√£o conseguiu corrigir, retorna o n√∫mero original sem @lid
      console.log(\`‚ö†Ô∏è [LidProcessor] Mantendo original: \${cleanNumber}\`);
      return cleanNumber;
      
    } catch (error) {
      this.stats.errors++;
      console.error(\`‚ùå [LidProcessor] Erro ao processar \${lidNumber}:\`, error.message);
      return lidNumber.toString().replace(/@lid$/, '');
    }
  }
  
  // üß† Corre√ß√£o inteligente baseada em padr√µes
  attemptIntelligentCorrection(lidNumber) {
    const numStr = lidNumber.toString();
    
    // Padr√£o 1: N√∫meros muito longos (possivelmente com timestamp)
    if (numStr.length > 15) {
      // Tentar extrair n√∫mero de telefone do in√≠cio
      const possiblePhone = numStr.substring(0, 13); // Pega primeiros 13 d√≠gitos
      if (possiblePhone.startsWith('55') && possiblePhone.length >= 12) {
        console.log(\`üîç [LidProcessor] Padr√£o timestamp detectado: \${numStr} ‚Üí tentando \${possiblePhone}\`);
        return possiblePhone;
      }
    }
    
    // Padr√£o 2: N√∫meros brasileiros (55 + DDD + n√∫mero)
    if (numStr.startsWith('55') && numStr.length >= 12 && numStr.length <= 15) {
      // Tentar formar n√∫mero brasileiro v√°lido
      let brazilianNumber = numStr.substring(0, 13); // 55 + 2 DDD + 9 n√∫mero
      if (brazilianNumber.length === 13) {
        console.log(\`üáßüá∑ [LidProcessor] Padr√£o brasileiro detectado: \${numStr} ‚Üí \${brazilianNumber}\`);
        return brazilianNumber;
      }
    }
    
    // Padr√£o 3: N√∫meros com prefixos conhecidos
    const commonPrefixes = ['1', '44', '49', '33', '39', '86', '91'];
    for (const prefix of commonPrefixes) {
      if (numStr.startsWith(prefix) && numStr.length >= 10) {
        const standardLength = prefix === '1' ? 11 : (prefix === '55' ? 13 : 12);
        if (numStr.length >= standardLength) {
          const corrected = numStr.substring(0, standardLength);
          console.log(\`üåç [LidProcessor] Padr√£o internacional (\${prefix}) detectado: \${numStr} ‚Üí \${corrected}\`);
          return corrected;
        }
      }
    }
    
    return null; // N√£o conseguiu corrigir
  }
  
  // üìä Adicionar mapeamento manualmente
  addMapping(lidNumber, realNumber) {
    const cleanLid = lidNumber.toString().replace(/@lid$/, '');
    this.knownLidMappings.set(cleanLid, realNumber.toString());
    this.processingCache.set(cleanLid, realNumber.toString());
    console.log(\`‚ûï [LidProcessor] Mapeamento adicionado: \${cleanLid}@lid ‚Üí \${realNumber}\`);
  }
  
  // üìà Obter estat√≠sticas
  getStats() {
    return {
      ...this.stats,
      cacheSize: this.processingCache.size,
      knownMappings: this.knownLidMappings.size,
      successRate: this.stats.total > 0 ? ((this.stats.corrected + this.stats.cached) / this.stats.total * 100).toFixed(2) + '%' : '0%'
    };
  }
  
  // üîç Listar mapeamentos conhecidos
  listKnownMappings() {
    console.log('üìã [LidProcessor] Mapeamentos conhecidos:');
    for (const [lid, real] of this.knownLidMappings.entries()) {
      console.log(\`   \${lid}@lid ‚Üí \${real}\`);
    }
    return Array.from(this.knownLidMappings.entries());
  }
  
  // üßπ Limpar cache (manter mapeamentos conhecidos)
  clearCache() {
    const cacheSize = this.processingCache.size;
    this.processingCache.clear();
    console.log(\`üßπ [LidProcessor] Cache limpo: \${cacheSize} entradas removidas\`);
  }
}

module.exports = LidProcessor;
EOF

echo '‚úÖ LidProcessor otimizado criado'
"

echo ""
echo "üîó 4. INTEGRANDO COM CONNECTION-MANAGER"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üìù Integrando LidProcessor no connection-manager...'

# Verificar se j√° existe import
if ! grep -q 'LidProcessor' src/utils/connection-manager.js; then
    # Adicionar import
    sed -i '/require.*dotenv/a const LidProcessor = require(\"./lid-processor\");' src/utils/connection-manager.js
    echo '‚úÖ Import do LidProcessor adicionado'
else
    echo '‚ÑπÔ∏è Import do LidProcessor j√° existe'
fi

# Verificar se j√° existe inicializa√ß√£o no constructor
if ! grep -q 'this.lidProcessor' src/utils/connection-manager.js; then
    # Adicionar inicializa√ß√£o no constructor
    sed -i '/console.log.*ConnectionManager inicializado/a\\
\\
    // üéØ PROCESSADOR OTIMIZADO DE @lid\\
    this.lidProcessor = new LidProcessor();' src/utils/connection-manager.js
    echo '‚úÖ Inicializa√ß√£o do LidProcessor adicionada no constructor'
else
    echo '‚ÑπÔ∏è LidProcessor j√° inicializado no constructor'
fi

echo '‚úÖ Integra√ß√£o com connection-manager conclu√≠da'
"

echo ""
echo "üîß 5. ADICIONANDO M√âTODO DE CORRE√á√ÉO NO CONNECTION-MANAGER"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üìù Adicionando m√©todo optimizado de corre√ß√£o @lid...'

# Verificar se m√©todo j√° existe
if ! grep -q 'correctLidNumber' src/utils/connection-manager.js; then
    # Adicionar m√©todo antes do √∫ltimo }
    sed -i '/^}$/i\\
\\
  // üéØ M√âTODO OTIMIZADO PARA CORRE√á√ÉO DE @lid\\
  correctLidNumber(number) {\\
    try {\\
      // Se n√£o cont√©m @lid, retorna como est√°\\
      if (!number.toString().includes(\"@lid\")) {\\
        return number;\\
      }\\
\\
      // Usar processador otimizado\\
      const corrected = this.lidProcessor.processLid(number);\\
      \\
      // Log apenas se houve corre√ß√£o\\
      if (corrected !== number.toString().replace(/@lid$/, \"\")) {\\
        console.log(\`üéØ [ConnectionManager] @lid corrigido: \${number} ‚Üí \${corrected}\`);\\
      }\\
\\
      return corrected;\\
\\
    } catch (error) {\\
      console.error(\`‚ùå [ConnectionManager] Erro na corre√ß√£o @lid:\`, error.message);\\
      return number.toString().replace(/@lid$/, \"\");\\
    }\\
  }\\
\\
  // üìä OBTER ESTAT√çSTICAS DE @lid\\
  getLidStats() {\\
    return this.lidProcessor ? this.lidProcessor.getStats() : { error: \"LidProcessor n√£o inicializado\" };\\
  }\\
\\
  // ‚ûï ADICIONAR MAPEAMENTO @lid MANUALMENTE\\
  addLidMapping(lidNumber, realNumber) {\\
    if (this.lidProcessor) {\\
      this.lidProcessor.addMapping(lidNumber, realNumber);\\
      return true;\\
    }\\
    return false;\\
  }' src/utils/connection-manager.js

    echo '‚úÖ M√©todos de corre√ß√£o @lid adicionados'
else
    echo '‚ÑπÔ∏è M√©todos de corre√ß√£o @lid j√° existem'
fi
"

echo ""
echo "üåê 6. ADICIONANDO ENDPOINTS DE @lid NO SERVER"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üìù Adicionando endpoints para gerenciar @lid no server.js...'

# Verificar se endpoints j√° existem
if ! grep -q '/lid-stats' server.js; then
    cat >> server.js << 'EOF'

// ================================
// üéØ ENDPOINTS DE GEST√ÉO @lid (PORTA 3001)
// ================================

// Estat√≠sticas de processamento @lid
app.get('/lid-stats', (req, res) => {
  try {
    const stats = connectionManager.getLidStats();
    res.json({
      success: true,
      message: 'Estat√≠sticas @lid obtidas',
      stats,
      port: 3001,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('Erro ao obter estat√≠sticas @lid:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});

// Adicionar mapeamento @lid manual
app.post('/lid-mapping', (req, res) => {
  try {
    const { lidNumber, realNumber } = req.body;
    
    if (!lidNumber || !realNumber) {
      return res.status(400).json({
        success: false,
        error: 'lidNumber e realNumber s√£o obrigat√≥rios',
        timestamp: new Date().toISOString()
      });
    }
    
    const success = connectionManager.addLidMapping(lidNumber, realNumber);
    
    res.json({
      success,
      message: success ? 'Mapeamento @lid adicionado' : 'Erro ao adicionar mapeamento',
      mapping: { lidNumber, realNumber },
      port: 3001,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('Erro ao adicionar mapeamento @lid:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});

// Testar corre√ß√£o @lid espec√≠fica
app.post('/lid-test', (req, res) => {
  try {
    const { number } = req.body;
    
    if (!number) {
      return res.status(400).json({
        success: false,
        error: 'number √© obrigat√≥rio',
        timestamp: new Date().toISOString()
      });
    }
    
    const corrected = connectionManager.correctLidNumber(number);
    
    res.json({
      success: true,
      original: number,
      corrected,
      wasChanged: corrected !== number.toString().replace(/@lid$/, ''),
      port: 3001,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('Erro ao testar corre√ß√£o @lid:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});
EOF
    echo '‚úÖ Endpoints de gest√£o @lid adicionados na porta 3001'
else
    echo '‚ÑπÔ∏è Endpoints @lid j√° existem'
fi
"

echo ""
echo "üîç 7. VALIDANDO SINTAXE E INTEGRA√á√ïES"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üìù Verificando sintaxe do lid-processor.js...'
node -c src/utils/lid-processor.js
if [ \$? -eq 0 ]; then
    echo '‚úÖ Sintaxe lid-processor.js v√°lida!'
else
    echo '‚ùå ERRO DE SINTAXE no lid-processor.js!'
fi

echo ''
echo 'üìù Verificando sintaxe do connection-manager.js...'
node -c src/utils/connection-manager.js
if [ \$? -eq 0 ]; then
    echo '‚úÖ Sintaxe connection-manager.js v√°lida!'
else
    echo '‚ùå ERRO DE SINTAXE no connection-manager.js!'
    echo 'üîÑ Restaurando backup...'
    LATEST_BACKUP=\$(ls -t src/utils/connection-manager.js.backup-lid-optimization* | head -1)
    if [ -n \"\$LATEST_BACKUP\" ]; then
        cp \"\$LATEST_BACKUP\" src/utils/connection-manager.js
        echo \"üìã Backup restaurado: \$LATEST_BACKUP\"
    fi
fi

echo ''
echo 'üìù Verificando sintaxe do server.js...'
node -c server.js
if [ \$? -eq 0 ]; then
    echo '‚úÖ Sintaxe server.js v√°lida!'
else
    echo '‚ùå ERRO DE SINTAXE no server.js!'
fi

echo ''
echo 'üîç Verificando integra√ß√µes:' 
grep -n 'LidProcessor' src/utils/connection-manager.js | head -3
grep -n '/lid-' server.js | head -3
"

echo ""
echo "üöÄ 8. REINICIANDO SISTEMA COM OTIMIZA√á√ÉO @lid"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üîÑ Reiniciando whatsapp-server com otimiza√ß√£o @lid...'
pm2 restart whatsapp-server

echo ''
echo '‚è≥ Aguardando 15 segundos para inicializa√ß√£o...'
sleep 15

echo ''
echo 'üìä Status PM2 ap√≥s restart:'
pm2 list

echo ''
echo 'üíæ Uso de mem√≥ria ap√≥s restart:'
ps aux | grep 'whatsapp-server/server.js' | grep -v grep | awk '{print \"üíæ whatsapp-server: \" int(\$6/1024) \"MB\"}'

echo ''
echo 'üéØ Verificando se servidor responde:'
curl -s http://localhost:3001/health | head -3 || echo '‚ùå Servidor n√£o responde'
"

echo ""
echo "üß™ 9. TESTANDO OTIMIZA√á√ÉO @lid"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üß™ Testando endpoints de @lid...'

echo ''
echo 'üìä Testando /lid-stats:'
curl -s http://localhost:3001/lid-stats | head -10 || echo '‚ùå Endpoint lid-stats n√£o responde'

echo ''
echo 'üéØ Testando corre√ß√£o do n√∫mero espec√≠fico 274293808169155@lid:'
curl -s -X POST http://localhost:3001/lid-test \\
  -H 'Content-Type: application/json' \\
  -d '{\"number\": \"274293808169155@lid\"}' | head -10 || echo '‚ùå Teste espec√≠fico falhou'

echo ''
echo 'üß™ Testando n√∫mero brasileiro padr√£o:'
curl -s -X POST http://localhost:3001/lid-test \\
  -H 'Content-Type: application/json' \\
  -d '{\"number\": \"5562987654321@lid\"}' | head -10 || echo '‚ùå Teste brasileiro falhou'

echo ''
echo 'üìã Verificando logs para inicializa√ß√£o do LidProcessor:'
pm2 logs whatsapp-server --lines 10 --nostream | grep -E 'LidProcessor|@lid' | tail -5 || echo 'Aguardando logs de inicializa√ß√£o...'
"

echo ""
echo "üìä 10. MONITORAMENTO DE PROCESSAMENTO @lid"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üîç Monitorando processamento @lid por 30 segundos...'
echo 'Aguardando n√∫meros @lid serem processados...'

for i in {1..6}; do
    echo \"\"
    echo \"üìä Check \$i/6 (a cada 5 segundos):\"
    echo \"Tempo: \$(date)\"
    
    # Verificar estat√≠sticas via endpoint
    STATS=\$(curl -s http://localhost:3001/lid-stats 2>/dev/null | grep -o '\"total\":[0-9]*' | cut -d: -f2 || echo '0')
    echo \"üìà N√∫meros processados: \$STATS\"
    
    # Verificar logs de @lid
    LID_LOGS=\$(pm2 logs whatsapp-server --lines 5 --nostream | grep -c '@lid' 2>/dev/null || echo '0')
    echo \"üìã Logs @lid recentes: \$LID_LOGS\"
    
    # Status geral
    STATUS=\$(curl -s http://localhost:3001/health >/dev/null && echo 'OK' || echo 'FALHA')
    echo \"üåê Status: \$STATUS\"
    
    sleep 5
done

echo ''
echo 'üìä Obtendo estat√≠sticas finais:'
curl -s http://localhost:3001/lid-stats | python3 -m json.tool 2>/dev/null || curl -s http://localhost:3001/lid-stats
"

echo ""
echo "‚úÖ 11. VERIFICA√á√ÉO FINAL OTIMIZA√á√ÉO @lid"
echo "================================================="
ssh $VPS_SERVER "
cd $VPS_PATH

echo 'üéØ VERIFICA√á√ÉO FINAL DA OTIMIZA√á√ÉO @lid:'
echo ''

# Status do servidor
SERVER_STATUS=\$(curl -s http://localhost:3001/health >/dev/null && echo 'OK' || echo 'FALHA')
echo \"üåê Servidor Principal (3001): \$SERVER_STATUS\"

# Status dos endpoints @lid
LID_ENDPOINT=\$(curl -s http://localhost:3001/lid-stats >/dev/null && echo 'OK' || echo 'FALHA')
echo \"üéØ Endpoints @lid: \$LID_ENDPOINT\"

# Verificar arquivos criados
if [ -f src/utils/lid-processor.js ]; then
    echo '‚úÖ LidProcessor criado e dispon√≠vel'
else
    echo '‚ùå LidProcessor n√£o encontrado'
fi

# Verificar integra√ß√£o
LID_INTEGRATION=\$(grep -c 'LidProcessor' src/utils/connection-manager.js)
echo \"üîó Integra√ß√µes LidProcessor: \$LID_INTEGRATION\"

# Mapeamentos conhecidos
KNOWN_MAPPINGS=\$(grep -c '274293808169155.*556281242215' src/utils/lid-processor.js 2>/dev/null || echo '0')
echo \"üìã Mapeamento espec√≠fico aplicado: \$KNOWN_MAPPINGS\"

echo ''
echo 'üéØ RESULTADO FINAL:'
if [ \"\$SERVER_STATUS\" = \"OK\" ] && [ \"\$LID_ENDPOINT\" = \"OK\" ] && [ -f src/utils/lid-processor.js ]; then
    echo 'üéâ ‚úÖ OTIMIZA√á√ÉO @lid IMPLEMENTADA COM SUCESSO!'
    echo 'üéØ LidProcessor otimizado funcionando'
    echo 'üìä Endpoints de gest√£o @lid dispon√≠veis'
    echo 'üß† Corre√ß√£o inteligente ativada'
    echo 'üìã Mapeamento espec√≠fico 274293808169155 ‚Üí 556281242215 aplicado'
    echo 'üöÄ Sistema preparado para processamento eficiente de @lid'
elif [ \"\$SERVER_STATUS\" = \"OK\" ]; then
    echo '‚ö†Ô∏è SERVIDOR OK, MAS OTIMIZA√á√ÉO PARCIAL'
    echo \"üéØ Endpoints @lid: \$LID_ENDPOINT\"
else
    echo '‚ùå PROBLEMA COM SERVIDOR - VERIFICAR LOGS'
    echo 'Use: pm2 logs whatsapp-server --lines 20'
fi

echo ''
echo 'üìã Endpoints @lid dispon√≠veis (porta 3001):'
echo '   ‚Ä¢ Estat√≠sticas: GET /lid-stats'
echo '   ‚Ä¢ Adicionar mapeamento: POST /lid-mapping'
echo '   ‚Ä¢ Testar corre√ß√£o: POST /lid-test'

echo ''
echo 'üß™ Exemplo de uso:'
echo '   curl -X POST http://localhost:3001/lid-test \\'
echo '   -H \"Content-Type: application/json\" \\'
echo '   -d \'{\"number\": \"274293808169155@lid\"}\''

echo ''
echo 'üÜò Se houver problemas, restaurar backup:'
LATEST_BACKUP=\$(ls -t src/utils/connection-manager.js.backup-lid-optimization* 2>/dev/null | head -1)
if [ -n \"\$LATEST_BACKUP\" ]; then
    echo \"   cp '\$LATEST_BACKUP' src/utils/connection-manager.js\"
    echo '   rm src/utils/lid-processor.js'
    echo '   pm2 restart whatsapp-server'
else
    echo '   ‚ö†Ô∏è Backup n√£o encontrado'
fi
"

echo ""
echo "‚úÖ OTIMIZA√á√ÉO @lid CONCLU√çDA!"
echo "================================================="
echo "üéØ Processador @lid otimizado implementado"
echo "üß† Corre√ß√£o inteligente baseada em padr√µes"
echo "üìã Mapeamento espec√≠fico 274293808169155 aplicado"
echo "üåê Endpoints de gest√£o dispon√≠veis na porta 3001"
echo "üìä Sistema preparado para processamento eficiente"