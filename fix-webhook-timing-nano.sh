#!/bin/bash
echo "ğŸ”§ CORREÃ‡ÃƒO DE TIMING DO WEBHOOK - USANDO NANO"
echo "============================================="
echo ""
echo "ğŸ“‹ INSTRUÃ‡Ã•ES PARA EDITAR O ARQUIVO server.js NA VPS:"
echo ""
echo "1ï¸âƒ£ Conecte na VPS:"
echo "   ssh root@31.97.163.57"
echo ""
echo "2ï¸âƒ£ Navegue para o diretÃ³rio:"
echo "   cd /opt/whatsapp-puppeteer"
echo ""
echo "3ï¸âƒ£ FaÃ§a backup do arquivo atual:"
echo "   cp server.js server.js.backup-$(date +%Y%m%d-%H%M%S)"
echo ""
echo "4ï¸âƒ£ Edite o arquivo:"
echo "   nano server.js"
echo ""
echo "ğŸ¯ ENCONTRE A SEÃ‡ÃƒO (aproximadamente linha 160-180):"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "PROCURE POR esta linha:"
echo "   // Capturar QR Code e converter para Base64"
echo ""
echo "VOCÃŠ VERÃ algo assim:"
echo "   const qrElement = await page.$('[data-ref] canvas');"
echo "   if (qrElement) {"
echo "     const qrCodeBuffer = await qrElement.screenshot();"
echo "     const qrCodeBase64 = qrCodeBuffer.toString('base64');"
echo "     "
echo "     // âŒ PROBLEMA: Estas linhas estÃ£o ERRADAS"
echo "     session.qrCodeBase64 = qrCodeBase64;"
echo "     session.status = 'waiting_qr';  // â† ERRADO!"
echo "     "
echo "     // Notificar webhook com QR Code"
echo "     await notifyWebhook(session, {"
echo "       qrCode: qrCodeBase64"
echo "     });"
echo "   }"
echo ""
echo "ğŸ”§ SUBSTITUA essas linhas por:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "   const qrElement = await page.$('[data-ref] canvas');"
echo "   if (qrElement) {"
echo "     const qrCodeBuffer = await qrElement.screenshot();"
echo "     const qrCodeBase64 = \`data:image/png;base64,\${qrCodeBuffer.toString('base64')}\`;"
echo "     "
echo "     // âœ… CORREÃ‡ÃƒO: SÃ³ atualiza status quando QR estiver REALMENTE pronto"
echo "     session.qrCodeBase64 = qrCodeBase64;"
echo "     session.status = 'qr_ready';  // â† CORRETO!"
echo "     session.message = 'QR Code gerado com sucesso!';"
echo "     session.progress = 25;"
echo "     "
echo "     console.log(\`âœ… [\${session.sessionId}] QR Code convertido para Base64 (\${qrCodeBase64.length} chars)\`);"
echo "     "
echo "     // ğŸ¯ WEBHOOK APENAS quando QR estiver 100% disponÃ­vel"
echo "     console.log(\`ğŸ”” [\${session.sessionId}] Enviando webhook com QR Code...\`);"
echo "     await notifyWebhook(session, {"
echo "       qrCode: qrCodeBase64,"
echo "       status: 'qr_ready'  // Status que indica QR pronto"
echo "     });"
echo "     "
echo "     console.log(\`âœ… [\${session.sessionId}] Webhook enviado com sucesso!\`);"
echo "   }"
echo ""
echo "ğŸ’¡ DICAS PARA USAR O NANO:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "   â€¢ Ctrl + W = Buscar texto"
echo "   â€¢ Ctrl + O = Salvar arquivo"
echo "   â€¢ Ctrl + X = Sair do nano"
echo "   â€¢ Page Up/Down = Navegar no arquivo"
echo ""
echo "ğŸ” BUSCAR TEXTO NO NANO:"
echo "   1. Pressione Ctrl + W"
echo "   2. Digite: qrCodeBase64 = qrCodeBuffer"
echo "   3. Pressione Enter"
echo "   4. Edite as linhas conforme mostrado acima"
echo ""
echo "5ï¸âƒ£ ApÃ³s editar, salve e saia:"
echo "   â€¢ Ctrl + O (salvar)"
echo "   â€¢ Enter (confirmar nome)"
echo "   â€¢ Ctrl + X (sair)"
echo ""
echo "6ï¸âƒ£ Reinicie o serviÃ§o:"
echo "   sudo systemctl restart whatsapp-puppeteer"
echo ""
echo "7ï¸âƒ£ Verifique se funcionou:"
echo "   sudo systemctl status whatsapp-puppeteer"
echo "   curl -s http://localhost:3001/health | jq '.webhook_timing_fix'"
echo ""
echo "ğŸ¯ RESULTADO ESPERADO:"
echo "   â€¢ webhook_timing_fix: true"
echo "   â€¢ QR Code nÃ£o serÃ¡ mais NULL no banco"
echo "   â€¢ Status 'qr_ready' apenas quando QR estiver pronto"
echo ""
echo "ğŸ“ Se precisar de ajuda:"
echo "   â€¢ Verifique os logs: journalctl -f -u whatsapp-puppeteer"
echo "   â€¢ Teste saÃºde: curl http://localhost:3001/health" 