Realizei uma varredura detalhada no frontend, backend, estrutura de autentica√ß√£o e edge functions. Aqui est√° o diagn√≥stico completo:

‚úÖ O QUE J√Å EST√Å IMPLEMENTADO E FUNCIONANDO:
1. Sistema de Convites (100% Funcional)
‚úÖ Frontend: useTeamManagement.ts chama corretamente send_native_invite
‚úÖ Edge Function: send_native_invite usa supabaseAdmin.auth.admin.inviteUserByEmail() nativo
‚úÖ Template Nativo: Envia email do Supabase com redirect para /invite/{token}
‚úÖ Tela /invite: AcceptInvite.tsx funciona perfeitamente, integra com accept_team_invite_safely
‚úÖ Redirecionamento: Ap√≥s criar senha ‚Üí vai para /login
2. Fun√ß√µes Implementadas no Banco
‚úÖ handle_new_user: Cria perfil como ADMIN com created_by_user_id = NEW.id (auto-refer√™ncia) ‚úÖ
‚úÖ handle_user_signup: Vincula perfis pendentes de convites ao auth.users
‚úÖ Sistema de Profiles: Estrutura correta com roles admin/operational
3. Frontend de Registro
‚úÖ RegisterForm.tsx: Funciona corretamente
‚úÖ AuthContext.signUp(): Configurado com emailRedirectTo: ${window.location.origin}/dashboard
‚úÖ Metadados: Envia full_name correto para raw_user_meta_data
‚ùå PROBLEMAS CR√çTICOS ENCONTRADOS:
1. TRIGGER AUSENTE (CR√çTICO)

-- ‚ùå PROBLEMA: N√£o existe trigger na tabela auth.users
-- ‚úÖ SOLU√á√ÉO NECESS√ÅRIA: Criar trigger que chama handle_new_user
IMPACTO: Usu√°rios que se registram N√ÉO t√™m perfil criado automaticamente na tabela profiles.

2. FUNIL PADR√ÉO N√ÉO AUTOM√ÅTICO (IMPORTANTE)
‚ùå Problema: N√£o h√° processo que crie "Funil Principal" automaticamente no registro
‚úÖ Observa√ß√£o: Funis existentes mostram padr√£o manual: "Funil Principal" com est√°gios estruturados
‚ö†Ô∏è Impacto: Usu√°rio novo fica sem funil at√© criar manualmente
3. EST√ÅGIOS PADR√ÉO N√ÉO AUTOM√ÅTICOS (IMPORTANTE)
‚ùå Problema: N√£o h√° cria√ß√£o autom√°tica de est√°gios padr√£o:
Entrada de Leads (ordem 1)
Em atendimento (ordem 2)
GANHO (is_won: true)
PERDIDO (is_lost: true)
üìã PLANO DE A√á√ÉO DETALHADO PARA PRODU√á√ÉO:
FASE 1 - CR√çTICA: Restaurar Auto-Cria√ß√£o de Perfil
Status: üî¥ BLOQUEANTE PARA PRODU√á√ÉO


-- Criar trigger que j√° deveria existir
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
FASE 2 - IMPORTANTE: Implementar Auto-Cria√ß√£o de Funil + Est√°gios
Status: üü° RECOMENDADO PARA PRODU√á√ÉO

Criar fun√ß√£o create_default_funnel_and_stages(user_id)
Modificar handle_new_user para chamar essa fun√ß√£o
Criar automaticamente:
Funil "Funil Principal"
Est√°gios padr√£o na ordem correta
FASE 3 - CONFIGURA√á√ÉO: Validar Dashboard Supabase
Status: ‚úÖ VERIFICAR CONFIGURA√á√ïES

‚úÖ SMTP j√° configurado (conforme informado)
‚ö†Ô∏è Verificar: Templates "Confirm signup" e "Invite user"
‚ö†Ô∏è Verificar: Site URL e Redirect URLs para produ√ß√£o
üö® SITUA√á√ÉO ATUAL PARA PRODU√á√ÉO:
‚úÖ FUNCIONA:
Convites de equipe (100% funcional)
Vincula√ß√£o de convites
Tela /invite
‚ùå N√ÉO FUNCIONA:
Usu√°rios novos ficam SEM perfil na tabela profiles
Usu√°rios novos ficam SEM funil padr√£o
Sistema quebra ao tentar acessar dados do usu√°rio
‚ö° RECOMENDA√á√ÉO:
Para colocar em produ√ß√£o HOJE, √© OBRIGAT√ìRIO implementar pelo menos a FASE 1 (trigger ausente). Sem isso, o sistema n√£o funcionar√° para novos usu√°rios.

A FASE 2 √© altamente recomendada para uma experi√™ncia completa do usu√°rio.

Deseja que eu implemente o plano para corrigir esses problemas cr√≠ticos?

PLANO DE IMPLEMENTA√á√ÉO PARA PRODU√á√ÉO

FASE 1 - CR√çTICA (OBRIGAT√ìRIA):

Criar trigger on_auth_user_created na tabela auth.users
Testar registro de novo usu√°rio
Verificar se perfil √© criado como admin com auto-refer√™ncia
FASE 2 - IMPORTANTE (RECOMENDADA):

Criar fun√ß√£o create_default_funnel_and_stages(user_id)
Modificar handle_new_user para criar funil + est√°gios automaticamente
Definir est√°gios padr√£o: Entrada ‚Üí Atendimento ‚Üí Negocia√ß√£o ‚Üí Ganho/Perdido
FASE 3 - CONFIGURA√á√ÉO:

Validar templates Supabase "Confirm signup" e "Invite user"
Configurar Site URL e Redirect URLs para produ√ß√£o
Testar fluxo completo: registro ‚Üí confirma√ß√£o ‚Üí login ‚Üí dashboard
RESULTADO: Sistema 100% funcional para novos registros e convites de equipe