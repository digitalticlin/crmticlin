[Webhook] ✅ Processamento concluído: { success: true, message: "Message processed completely with existing infrastructure", data: { phone: "55639944****", lead_id: "d0ecc9e3-e777-4e2e-a99c-d8eaa4c56c90", user_id: "152f2390-ede4-4f46-89bc-da3d7f5da747", has_media: false, media_type: "text", message_id: "58b23db4-13a1-4064-9ef5-29b37acc9de9", instance_id: "d1d34909-3546-4dee-93fc-083f95323bc6", formatted_name: "+55 (63) 99449-959", media_cache_id: null, mediaProcessed: false, usedExistingInfrastructure: true } }
[Webhook] ✅ Mensagem salva: { messageId: "58b23db4-13a1-4064-9ef5-29b37acc9de9", leadId: "d0ecc9e3-e777-4e2e-a99c-d8eaa4c56c90", fromMe: false }
[Webhook] 📋 PAYLOAD COMPLETO VPS: { allKeys: [ "event", "instanceId", "instanceName", "from", "fromMe", "messageType", "message", "timestamp", "createdByUserId", "data" ], messageType: "text", mediabase64_exists: false, mediaData_exists: false, base64Data_exists: false, media_exists: false, buffer_exists: false, content_exists: false, data_buffer_exists: false, data_base64_exists: false, message_media_exists: false, payload_size: 534 }
[Webhook] 💾 Salvando mensagem no banco...
[Webhook] 📨 Processando mensagem com infraestrutura existente: { instanceId: "imperioesportegyn", hasMessage: true, fromMe: undefined, messageType: "text", hasMediaData: false, hasCaption: false }
[Webhook] 🔄 Processando evento: { event: "message_received", instanceId: "imperioesportegyn", hasMessage: true, hasMediaData: false, timestamp: "2025-08-07T15:53:14.844Z" }
[Webhook] ⚠️ Sem verificação de signature - MODO DESENVOLVIMENTO
[Webhook] 📨 Recebendo webhook: { method: "POST", contentLength: 534, timestamp: "2025-08-07T15:53:14.842Z" }
[Webhook] 🔑 Signature recebida: false
Listening on http://localhost:9999/
[Webhook] 🚀 Inicializando webhook WhatsApp Web v3.0 - USANDO INFRAESTRUTURA EXISTENTE
[Webhook] 🔑 Webhook secret configurado: false
booted (time: 30ms)
[Webhook] ✅ Processamento concluído: { success: true, message: "Message processed completely with existing infrastructure", data: { phone: "55669723****", lead_id: "bc081653-63a2-41c3-a8a4-ac64212e6d01", user_id: "8cf224c2-2bed-4687-89a9-8639e76acd47", has_media: false, media_type: "text", message_id: "097b8782-c005-4275-988f-f64f9dbf77c4", instance_id: "589b304a-6d90-46b8-8f15-e4c0496e5213", formatted_name: "+55 (66) 97239-377", media_cache_id: null, mediaProcessed: false, usedExistingInfrastructure: true } }
[Webhook] ✅ Mensagem salva: { messageId: "097b8782-c005-4275-988f-f64f9dbf77c4", leadId: "bc081653-63a2-41c3-a8a4-ac64212e6d01", fromMe: false }
[Webhook] 💾 Salvando mensagem no banco...
[Webhook] 📨 Processando mensagem com infraestrutura existente: { instanceId: "marketing", hasMessage: true, fromMe: undefined, messageType: "text", hasMediaData: false, hasCaption: false }
[Webhook] 📋 PAYLOAD COMPLETO VPS: { allKeys: [ "event", "instanceId", "instanceName", "from", "fromMe", "messageType", "message", "timestamp", "createdByUserId", "data" ], messageType: "text", mediabase64_exists: false, mediaData_exists: false, base64Data_exists: false, media_exists: false, buffer_exists: false, content_exists: false, data_buffer_exists: false, data_base64_exists: false, message_media_exists: false, payload_size: 550 }
[Webhook] ⚠️ Sem verificação de signature - MODO DESENVOLVIMENTO
[Webhook] 🔑 Signature recebida: false
[Webhook] 📨 Recebendo webhook: { method: "POST", contentLength: 550, timestamp: "2025-08-07T15:53:10.708Z" }
[Webhook] 🔄 Processando evento: { event: "message_received", instanceId: "marketing", hasMessage: true, hasMediaData: false, timestamp: "2025-08-07T15:53:10.710Z" }
Listening on http://localhost:9999/
[Webhook] 🚀 Inicializando webhook WhatsApp Web v3.0 - USANDO INFRAESTRUTURA EXISTENTE
[Webhook] 🔑 Webhook secret configurado: false
booted (time: 31ms)
[Webhook] ✅ Processamento concluído: { success: false, error: "Failed to save message" }
[Webhook] ❌ Erro ao salvar mensagem: { error: 'invalid input value for enum media_type: "sticker"', method: "service_role_error", success: false, sqlstate: "22P02" }
[Webhook] 💾 Salvando mensagem no banco...
[Webhook] 📨 Processando mensagem com infraestrutura existente: { instanceId: "imperioesportegyn", hasMessage: true, fromMe: true, messageType: "sticker", hasMediaData: false, hasCaption: false }
[Webhook] 🔍 INVESTIGAÇÃO DE MÍDIA DETALHADA: { messageType: "sticker", topLevelKeys: [ "event", "instanceId", "instanceName", "from", "fromMe", "messageType", "message", "timestamp", "createdByUserId", "data" ], directMedia: { mediabase64: null, mediaData: undefined, base64Data: null, media: undefined, buffer: null, content: null }, nestedMedia: { data_keys: [ "messageId", "body", "from", "fromMe", "timestamp", "messageType", "mediaUrl", "mediaBase64", "mediaSize", "instancePhone" ], data_buffer: null, data_base64: null, message_keys: [ "text" ], message_media: undefined } }
[Webhook] 🔄 Processando evento: { event: "message_received", instanceId: "imperioesportegyn", hasMessage: true, hasMediaData: false, timestamp: "2025-08-07T15:53:03.413Z" }
[Webhook] 📋 PAYLOAD COMPLETO VPS: { allKeys: [ "event", "instanceId", "instanceName", "from", "fromMe", "messageType", "message", "timestamp", "createdByUserId", "data" ], messageType: "sticker", mediabase64_exists: false, mediaData_exists: false, base64Data_exists: false, media_exists: false, buffer_exists: false, content_exists: false, data_buffer_exists: false, data_base64_exists: false, message_media_exists: false, payload_size: 510 }
[Webhook] 🔑 Signature recebida: false
[Webhook] ⚠️ Sem verificação de signature - MODO DESENVOLVIMENTO
[Webhook] 📨 Recebendo webhook: { method: "POST", contentLength: 510, timestamp: "2025-08-07T15:53:03.412Z" }
[Webhook] 🔑 Webhook secret configurado: false
Listening on http://localhost:9999/
[Webhook] 🚀 Inicializando webhook WhatsApp Web v3.0 - USANDO INFRAESTRUTURA EXISTENTE
booted (time: 24ms)
[Webhook] ✅ Processamento concluído: { success: true, message: "Message processed completely with existing infrastructure", data: { phone: "55639944****", lead_id: "d0ecc9e3-e777-4e2e-a99c-d8eaa4c56c90", user_id: "152f2390-ede4-4f46-89bc-da3d7f5da747", has_media: false, media_type: "text", message_id: "c096c295-165a-4ea7-bbfd-dd41a4c422d7", instance_id: "d1d34909-3546-4dee-93fc-083f95323bc6", formatted_name: "+55 (63) 99449-959", media_cache_id: null, mediaProcessed: false, usedExistingInfrastructure: true } }
[Webhook] ✅ Mensagem salva: { messageId: "c096c295-165a-4ea7-bbfd-dd41a4c422d7", leadId: "d0ecc9e3-e777-4e2e-a99c-d8eaa4c56c90", fromMe: false }
[Webhook] 📨 Processando mensagem com infraestrutura existente: { instanceId: "imperioesportegyn", hasMessage: true, fromMe: undefined, messageType: "text", hasMediaData: false, hasCaption: false }
[Webhook] 💾 Salvando mensagem no banco...
[Webhook] 📋 PAYLOAD COMPLETO VPS: { allKeys: [ "event", "instanceId", "instanceName", "from", "fromMe", "messageType", "message", "timestamp", "createdByUserId", "data" ], messageType: "text", mediabase64_exists: false, mediaData_exists: false, base64Data_exists: false, media_exists: false, buffer_exists: false, content_exists: false, data_buffer_exists: false, data_base64_exists: false, message_media_exists: false, payload_size: 534 }
[Webhook] 🔄 Processando evento: { event: "message_received", instanceId: "imperioesportegyn", hasMessage: true, hasMediaData: false, timestamp: "2025-08-07T15:53:02.760Z" }
[Webhook] 📨 Recebendo webhook: { method: "POST", contentLength: 534, timestamp: "2025-08-07T15:53:02.758Z" }
[Webhook] 🔑 Signature recebida: false
[Webhook] ⚠️ Sem verificação de signature - MODO DESENVOLVIMENTO
Listening on http://localhost:9999/
[Webhook] 🔑 Webhook secret configurado: false
[Webhook] 🚀 Inicializando webhook WhatsApp Web v3.0 - USANDO INFRAESTRUTURA EXISTENTE
booted (time: 31ms)
shutdown
shutdown
[Webhook] ✅ Processamento concluído: { success: true, message: "Message processed completely with existing infrastructure", data: { phone: "55669211****", lead_id: "c7d86711-7b75-4bf3-8177-ac0dc5bae150", user_id: "152f2390-ede4-4f46-89bc-da3d7f5da747", has_media: false, media_type: "image", message_id: "ecb25ebe-12a5-44a7-a752-9d79821b5ae5", instance_id: "d1d34909-3546-4dee-93fc-083f95323bc6", formatted_name: "+55 (66) 92119-303", media_cache_id: null, mediaProcessed: true, usedExistingInfrastructure: true } }
[Webhook] ✅ Mídia processada com infraestrutura existente
[Media] ✅ Processamento síncrono com Storage concluído: { messageId: "ecb25ebe-12a5-44a7-a752-9d79821b5ae5", fileName: "media_1754581856966_wlawrd.jpg", storageUrl: "https://rhjgagzstjzynvrakdyj.supabase.co/storage/v1/object/public/whatsapp-media...", fileSize: 91310 }
[Media] 🍎 Processando mídia com detecção avançada: { originalType: "image", detectedMime: "image/jpeg", extension: "jpg", isAppleFormat: false, sizeMB: "0.09" }
[Media] 🔄 Processamento síncrono com Storage existente: ecb25ebe-12a5-44a7-a752-9d79821b5ae5
[Media] 📊 Processando mídia com limites dinâmicos: { messageId: "ecb25ebe-12a5-44a7-a752-9d79821b5ae5", externalMessageId: undefined, mediaType: "image", sizeBytes: 121771, sizeMB: "0.12", limitMB: "5.00", willProcessSync: true, isValid: true, validationError: undefined }
[Webhook] 🎬 Processando mídia usando Storage + PGMQ existentes...
[Webhook] ✅ Mensagem salva: { messageId: "ecb25ebe-12a5-44a7-a752-9d79821b5ae5", leadId: "c7d86711-7b75-4bf3-8177-ac0dc5bae150", fromMe: false }
[Webhook] 📨 Processando mensagem com infraestrutura existente: { instanceId: "imperioesportegyn", hasMessage: true, fromMe: undefined, messageType: "image", hasMediaData: true, hasCaption: false }
[Webhook] 💾 Salvando mensagem no banco...
[Webhook] 📋 PAYLOAD COMPLETO VPS: { allKeys: [ "event", "instanceId", "instanceName", "from", "fromMe", "messageType", "message", "timestamp", "createdByUserId", "data" ], messageType: "image", mediabase64_exists: false, mediaData_exists: false, base64Data_exists: false, media_exists: false, buffer_exists: false, content_exists: false, data_buffer_exists: false, data_base64_exists: false, message_media_exists: false, payload_size: 122500 }
[Webhook] 🔍 INVESTIGAÇÃO DE MÍDIA DETALHADA: { messageType: "image", topLevelKeys: [ "event", "instanceId", "instanceName", "from", "fromMe", "messageType", "message", "timestamp", "createdByUserId", "data" ], directMedia: { mediabase64: null, mediaData: undefined, base64Data: null, media: undefined, buffer: null, content: null }, nestedMedia: { data_keys: [ "messageId", "body", "from", "fromMe", "timestamp", "messageType", "mediaUrl", "mediaBase64", "mediaSize", "instancePhone" ], data_buffer: null, data_base64: null, message_keys: [ "text" ], message_media: undefined } }
[Webhook] 🔄 Processando evento: { event: "message_received", instanceId: "imperioesportegyn", hasMessage: true, hasMediaData: false, timestamp: "2025-08-07T15:50:56.828Z" }
[Webhook] 🔑 Signature recebida: false
[Webhook] ⚠️ Sem verificação de signature - MODO DESENVOLVIMENTO
[Webhook] 📨 Recebendo webhook: { method: "POST", contentLength: 122500, timestamp: "2025-08-07T15:50:56.826Z" }
Listening on http://localhost:9999/
[Webhook] 🔑 Webhook secret configurado: false
[Webhook] 🚀 Inicializando webhook WhatsApp Web v3.0 - USANDO INFRAESTRUTURA EXISTENTE
booted (time: 30ms)