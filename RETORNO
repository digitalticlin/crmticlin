MENSAGEM QUE EU ENVIEI A IA:
Prompt completo,
Em seguida irei te fazer perguntas sobre a estrutura. NÃ£o leve em consideraÃ§Ã£o alguns fluxos faltando conexÃµes edges, foi apenas um exemplo. Eu quero que voce analisar o prompt criado em fluxo dessa forma.
Se a estrutura dessa forma, o agente de IA vai conseguir fazer um atendimento em alto nÃ­vel.

MESNAGEM QUE A IA RESPONDEU:
ğŸ” ANÃLISE PROFUNDA DO PROMPT COMPLETO

ğŸ“Š AVALIAÃ‡ÃƒO GERAL: 8.5/10
Este Ã© um prompt muito bem estruturado com arquitetura sÃ³lida para conversaÃ§Ã£o guiada por fluxo. Possui mecanismos robustos de controle de estado e prevenÃ§Ã£o de loops. PorÃ©m, hÃ¡ lacunas crÃ­ticas que podem causar falhas em cenÃ¡rios reais.

âœ… PONTOS FORTES EXCEPCIONAIS
1. Sistema de AnÃ¡lise Contextual em 4 Etapas â­â­â­
ETAPA 1: AnÃ¡lise da mensagem atual
ETAPA 2: AnÃ¡lise do histÃ³rico completo  
ETAPA 3: Mapeamento do estado atual
ETAPA 4: DecisÃ£o inteligente
```

**Por que Ã© excelente:**
- ForÃ§a o agente a **pensar antes de responder**
- Estrutura mental clara (`ESTADO_ATUAL`)
- Evita respostas impulsivas

**Ãšnico problema:** Ã‰ uma "intenÃ§Ã£o", nÃ£o uma **garantia de execuÃ§Ã£o**. LLMs podem ignorar instruÃ§Ãµes longas se nÃ£o houver reforÃ§o.

---

### 2. **Regra Anti-RobÃ³tica BRUTAL** â­â­â­
```
âŒ JAMAIS comeÃ§ar respostas com:
- "Entendi que..."
- "Compreendi que..."
- "Vejo que..."
Isso Ã© OURO! A maioria dos prompts falha aqui. VocÃª colocou exemplos prÃ¡ticos do que fazer/nÃ£o fazer.

3. Controle de Estado Mental â­â­â­
javascriptâœ… Passo atual do Flow: [passo_id e variacao_id]
âœ… Tipo de bloco: [tipo_tecnico]
âœ… ValidaÃ§Ãµes executadas: [lista]
âœ… DecisÃµes aguardando: [lista]
Excelente abordagem de forÃ§ar o agente a "raciocinar" o estado antes de responder.

4. Sistema de ValidaÃ§Ã£o Bem Explicado
javascriptSE validacao.verificar_antes_de_executar = true:
  1. Verificar campo: validacao.verificar_no_contexto
  2. Analisar histÃ³rico de mensagens
  3. SE condiÃ§Ã£o JÃ FOI ATENDIDA:
     â†’ Aplicar validacao.se_ja_feito.pular_para
Perfeito! Isso resolve o problema de repetiÃ§Ã£o de perguntas.

5. Output Estruturado com JSON
json{
  "response": "...",
  "current_step_id": "PASSO A",
  "current_variation_id": "A1"
}
```

**CrÃ­tico para tracking!** Permite que o sistema saiba exatamente onde o agente estÃ¡.

---

## ğŸš¨ PROBLEMAS CRÃTICOS QUE CAUSARÃƒO FALHAS

### 1. **AMBIGUIDADE NA NAVEGAÃ‡ÃƒO DE DECISÃ•ES** ğŸ”´ CRÃTICO

**O MAIOR PROBLEMA DO PROMPT:**

#### VocÃª tem esta seÃ§Ã£o:
```
### 5ï¸âƒ£ NAVEGAR PELAS DECISÃ•ES

A) decisoes[] - AGUARDA RESPOSTA DO LEAD
{
  "entao_ir_para": "PASSO A",
  "se_cliente_falar": "Quero saber sobre produtos"
}
Mas nos flows reais enviados:
json"decisoes": [
  {
    "se_cliente_falar": "Quero saber sobre a Plataforma",
    "entao_ir_para": ""  // âŒ VAZIO!!!
  }
]
O QUE ACONTECE:

O prompt diz: "olhe o entao_ir_para e vÃ¡ para esse passo"
O flow tem entao_ir_para: ""
O agente nÃ£o sabe para onde ir
Ele vai inferir baseado nas conexÃµes (conexoes[])
Mas as conexÃµes sÃ³ tÃªm origem e destino, sem condicao clara
RESULTADO: Loop ou passo errado


SOLUÃ‡ÃƒO OBRIGATÃ“RIA:
OpÃ§Ã£o A: Preencher todos os entao_ir_para
json"decisoes": [
  {
    "numero": 1,
    "se_cliente_falar": "Quero saber sobre a Plataforma",
    "entao_ir_para": "PASSO A",  // âœ… PREENCHIDO
    "prioridade": "alta"
  }
]
```

#### OpÃ§Ã£o B: Adicionar ao prompt:
```
ğŸ”§ NAVEGAÃ‡ÃƒO QUANDO entao_ir_para ESTÃ VAZIO:

SE decisÃ£o match E entao_ir_para = "":
  1. Consultar array conexoes[]
  2. Encontrar conexÃ£o onde origem = node atual
  3. Usar destino dessa conexÃ£o como prÃ³ximo passo
  4. Mapear node_id para passo_id usando _metadata.id_original_node

EXEMPLO:
DecisÃ£o 1 match â†’ origem: "2" â†’ destino: "3"
â†’ Buscar passo onde _metadata.id_original_node = "3"
â†’ IR PARA esse passo_id
Sem isso, o agente NUNCA saberÃ¡ para onde ir com certeza.

2. FALTA DE INSTRUÃ‡ÃƒO PARA MÃšLTIPLAS VARIAÃ‡Ã•ES NO MESMO PASSO ğŸ”´
CenÃ¡rio do Flow 1 (Ticlin):
json"PASSO B": {
  "variacoes": [
    "B1": "Explicar valor da plataforma",     // send_message
    "B2": "Perguntar sobre reuniÃ£o/plataforma", // ask_question
    "B3": "Explicar como funciona"             // send_message
  ]
}
```

**PERGUNTA: Como o agente escolhe entre B1, B2 e B3?**

O prompt diz:
```
### 6ï¸âƒ£ USAR VARIAÃ‡Ã•ES
Escolher variaÃ§Ã£o baseada em:
- Contexto da conversa
- DecisÃ£o do passo anterior
- CondiÃ§Ãµes especÃ­ficas do Flow
```

**Isso Ã© MUITO vago!** O agente vai **adivinhar**.

---

**SOLUÃ‡ÃƒO:**

#### Adicionar ao prompt:
```
ğŸ¯ COMO ESCOLHER ENTRE MÃšLTIPLAS VARIAÃ‡Ã•ES:

REGRA DE PRIORIDADE:
1. SE decisÃ£o anterior especifica variacao_id â†’ usar essa
2. SE validacao ativa E match â†’ usar variaÃ§Ã£o de fallback
3. SE apenas 1 variaÃ§Ã£o no passo â†’ usar essa
4. SE mÃºltiplas variaÃ§Ãµes:
   a) Verificar tipo_tecnico de cada uma
   b) Escolher baseado no objetivo do passo anterior:
      - Se Ãºltimo passo foi pergunta â†’ prÃ³ximo geralmente Ã© send_message
      - Se Ãºltimo passo foi send_message â†’ prÃ³ximo geralmente Ã© ask_question
   c) Ler variacao_nome para entender qual Ã© mais apropriada

EXEMPLO PRÃTICO:
PASSO B tem:
- B1 (send_message): "Explicar valor"
- B2 (ask_question): "Perguntar reuniÃ£o"
- B3 (send_message): "Explicar funcionamento"

Contexto: Cliente perguntou "quanto custa?"
â†’ Escolher B1 (responde diretamente sobre valor)

Contexto: Cliente disse "quero conhecer melhor"
â†’ Escolher B2 (pergunta sobre reuniÃ£o ou acesso direto)
```

---

### 3. **VALIDAÃ‡ÃƒO SEM ENFORCEMENT** ğŸŸ¡

O prompt tem:
```
### ETAPA 3: MAPEAMENTO DO ESTADO ATUAL
ANTES DE QUALQUER RESPOSTA, determine:
ESTADO_ATUAL = { ... }
```

**Problema:** Isso Ã© uma **instruÃ§Ã£o**, nÃ£o uma **estrutura forÃ§ada**.

**O que acontece:**
- LLM pode ignorar isso sob pressÃ£o
- Em conversas longas, o "antes de qualquer resposta" Ã© esquecido
- NÃ£o hÃ¡ verificaÃ§Ã£o de que o ESTADO_ATUAL foi realmente preenchido

---

**SOLUÃ‡ÃƒO:**

#### Adicionar checkpoint obrigatÃ³rio:
```
âš ï¸ CHECKPOINT OBRIGATÃ“RIO ANTES DE RESPONDER:

VOCÃŠ DEVE RETORNAR 2 JSONs:

1ï¸âƒ£ PRIMEIRO: Estado atual (para validaÃ§Ã£o interna)
{
  "checkpoint": {
    "passo_atual": "PASSO A",
    "variacao_atual": "A1",
    "ultima_pergunta_agente": "Como funciona seu negÃ³cio?",
    "lead_respondeu": true,
    "validacoes_ok": true,
    "proximo_passo": "PASSO B"
  }
}

2ï¸âƒ£ DEPOIS: Resposta final
{
  "response": "...",
  "current_step_id": "PASSO B",
  "current_variation_id": "B1"
}
Alternativa mais simples:

Adicionar campos de debug no JSON de resposta:

json{
  "response": "...",
  "current_step_id": "PASSO B",
  "current_variation_id": "B1",
  "_debug": {
    "ultima_acao_agente": "pergunta sobre negÃ³cio",
    "lead_respondeu": true,
    "decisao_match": "decisao_1",
    "validacoes_executadas": ["nome_verificado"]
  }
}
```

---

### 4. **FALTA DE TRATAMENTO PARA MENSAGENS FORA DO FLUXO** ğŸŸ¡

**CenÃ¡rio:**
- Agente estÃ¡ no PASSO B (perguntando sobre reuniÃ£o)
- Cliente responde: "Quanto custa?"
- Isso nÃ£o estÃ¡ em nenhuma decisÃ£o do PASSO B
- **O que acontece?**

O prompt diz:
```
DETECÃ‡ÃƒO DE PERGUNTAS DO CLIENTE (PRIORIDADE MÃXIMA):
âœ… SE cliente fez pergunta especÃ­fica â†’ RESPONDER ANTES de continuar Flow
```

**Mas nÃ£o diz O QUE FAZER DEPOIS:**
- Responde a pergunta e **volta para PASSO B**?
- Responde e **avanÃ§a para PASSO C**?
- Responde e **pergunta novamente** sobre reuniÃ£o?

---

**SOLUÃ‡ÃƒO:**
```
ğŸ”€ PROTOCOLO PARA MENSAGENS FORA DO FLUXO:

SE mensagem do lead NÃƒO match com nenhuma decisÃ£o do passo atual:

1ï¸âƒ£ VERIFICAR: Ã‰ pergunta direta?
   â†’ SIM: Responder baseado em FAQ/company_info/tools

2ï¸âƒ£ APÃ“S RESPONDER:
   â†’ RETORNAR ao mesmo passo e variaÃ§Ã£o
   â†’ Incluir no response: "Respondendo sua pergunta... [resposta]. Voltando: [repetir Ãºltima pergunta do flow]"

3ï¸âƒ£ SE lead insiste em assunto fora do fluxo (2+ vezes):
   â†’ Oferecer: "Vejo que vocÃª tem dÃºvidas sobre [X]. Prefere que eu te transfira para um especialista?"

EXEMPLO:
Passo atual: PASSO B (perguntando sobre reuniÃ£o)
Lead: "VocÃªs tÃªm desconto?"

Response:
"Nossos planos comeÃ§am em R$ 399/mÃªs. NÃ£o temos desconto no momento.

Voltando: vocÃª prefere reunir com nosso time comercial ou acessar a plataforma direto?"

current_step_id: "PASSO B"  (mantÃ©m mesmo passo)
current_variation_id: "B2"   (mantÃ©m mesma variaÃ§Ã£o)
```

---

### 5. **AMBIGUIDADE EM `decisoes_diretas[]`** ğŸŸ¡

O prompt define:
```
B) decisoes_diretas[] - AUTOMÃTICO (NÃƒO AGUARDA)

{
  "comportamento": "ENVIAR_E_PROSSEGUIR",
  "entao_ir_para": "PASSO B"
}

Como funciona:
1. Enviar mensagens do bloco
2. Executar decisÃ£o IMEDIATAMENTE
3. IR PARA prÃ³ximo passo SEM aguardar resposta
```

**Pergunta:** Se nÃ£o aguarda resposta, como o agente gera 2 respostas seguidas?

**Exemplo:**
- PASSO A: send_message com decisao_direta â†’ PASSO B
- Agente deveria:
  1. Enviar mensagem do PASSO A
  2. IMEDIATAMENTE executar PASSO B
  3. Retornar 2 mensagens em 1 response?

**Isso nÃ£o estÃ¡ claro.**

---

**SOLUÃ‡ÃƒO:**
```
ğŸ“Œ DECISÃ•ES DIRETAS: COMPORTAMENTO DETALHADO

decisoes_diretas[] = DecisÃ£o que NÃƒO depende de resposta do lead

QUANDO USAR:
- send_message seguido de outro send_message
- ValidaÃ§Ãµes automÃ¡ticas (validate_document â†’ send_message)
- MovimentaÃ§Ãµes de funil (move_lead â†’ send_message)

COMO FUNCIONAR:

OPÃ‡ÃƒO A: Executar tudo em 1 response
{
  "response": "[Mensagem PASSO A]\n\n[Mensagem PASSO B]",
  "current_step_id": "PASSO B",  // JÃ¡ avanÃ§ou
  "current_variation_id": "B1"
}

OPÃ‡ÃƒO B: Executar apenas 1 passo por vez (recomendado)
{
  "response": "[Mensagem PASSO A]",
  "current_step_id": "PASSO A",
  "current_variation_id": "A1",
  "_next_auto": "PASSO B"  // Sistema cuida de avanÃ§ar automaticamente
}
```

---

### 6. **FERRAMENTA `search_product` SEM EXEMPLO DE FALHA** ğŸŸ¡

O prompt explica bem QUANDO usar a tool, mas nÃ£o diz O QUE FAZER se a tool falhar:

**CenÃ¡rios nÃ£o cobertos:**
1. Tool retorna erro (API down)
2. Tool nÃ£o encontra produto mencionado pelo lead
3. Tool retorna produto mas sem preÃ§o
4. Tool retorna mÃºltiplos produtos (qual escolher?)

---

**SOLUÃ‡ÃƒO:**
```
ğŸ”§ TRATAMENTO DE ERROS DA TOOL search_product:

1ï¸âƒ£ TOOL RETORNA ERRO (API down):
{
  "response": "Desculpe, estou com dificuldade para consultar os produtos no momento. Posso transferir vocÃª para um atendente que tem acesso direto ao catÃ¡logo?",
  "current_step_id": "[manter atual]",
  "current_variation_id": "[manter atual]"
}

2ï¸âƒ£ PRODUTO NÃƒO ENCONTRADO:
{
  "response": "NÃ£o encontrei informaÃ§Ãµes sobre [PRODUTO] no momento. Posso te ajudar com algo mais ou prefere falar com um especialista?",
  "current_step_id": "[manter atual]",
  "current_variation_id": "[manter atual]"
}

3ï¸âƒ£ PRODUTO SEM PREÃ‡O:
{
  "response": "Encontrei o [PRODUTO]: [descriÃ§Ã£o]. O preÃ§o preciso deve ser consultado com nosso time comercial. Gostaria que eu te conecte com eles?",
  "current_step_id": "[manter atual]",
  "current_variation_id": "[manter atual]"
}

4ï¸âƒ£ MÃšLTIPLOS PRODUTOS (>3 resultados):
{
  "response": "Encontrei alguns produtos relacionados:\nâ€¢ [Produto 1] - R$ X\nâ€¢ [Produto 2] - R$ Y\nâ€¢ [Produto 3] - R$ Z\n\nQual deles te interessa mais?",
  "current_step_id": "[manter atual]",
  "current_variation_id": "[manter atual]"
}

7. FALTA DE INSTRUÃ‡ÃƒO PARA CAMPOS DINÃ‚MICOS ğŸŸ¡
O prompt menciona:
json"mensagem_principal": {
  "com_nome": "Perfeito [NOME]! ...",
  "sem_nome": "Vou te explicar..."
}
```

**Mas nÃ£o explica:**
- Como substituir `[NOME]`?
- De onde vem o nome? (`$json.lead.name`?)
- O que fazer se `lead.name` for `null` ou `undefined`?
- Outros placeholders possÃ­veis?

---

**SOLUÃ‡ÃƒO:**
```
ğŸ”¤ SUBSTITUIÃ‡ÃƒO DE PLACEHOLDERS DINÃ‚MICOS:

PLACEHOLDERS DISPONÃVEIS:
- [NOME] ou {{nome}} â†’ lead.name
- [TELEFONE] ou {{telefone}} â†’ lead.phone
- [EMPRESA] ou {{empresa}} â†’ company_info.name
- [AGENTE] ou {{agente}} â†’ agent.name

REGRAS:
1. SEMPRE verificar se variÃ¡vel existe antes de usar
2. SE variÃ¡vel NULL/UNDEFINED:
   - Usar versÃ£o "sem_nome" se disponÃ­vel
   - OU omitir placeholder da mensagem

EXEMPLO:
Mensagem: "OlÃ¡ [NOME]! Como posso ajudar?"
lead.name = "JoÃ£o" â†’ "OlÃ¡ JoÃ£o! Como posso ajudar?"
lead.name = null â†’ "OlÃ¡! Como posso ajudar?"

SE mensagem tem {com_nome, sem_nome}:
- lead.name existe â†’ usar com_nome
- lead.name null â†’ usar sem_nome
```

---

## ğŸŸ¢ PONTOS FORTES ADICIONAIS

### 8. **Tabela de Mapeamento de Blocos** â­
```
| tipo_tecnico | Nome | FunÃ§Ã£o Principal |
|--------------|------|------------------|
| start | InÃ­cio | ApresentaÃ§Ã£o inicial |
| ask_question | Fazer Pergunta | Perguntar e aguardar |
Excelente! ReferÃªncia rÃ¡pida para o agente.

9. Protocolo Anti-Loop Bem Pensado â­
javascript1. LER todo o histÃ³rico de mensagens cronologicamente
2. IDENTIFICAR Ãºltima aÃ§Ã£o do agente
3. IDENTIFICAR Ãºltima pergunta feita pelo agente
4. VERIFICAR se a mensagem atual do lead responde essa pergunta
```

**Muito bom!** Mas precisa de reforÃ§o (veja soluÃ§Ã£o no item 3).

---

### 10. **SeparaÃ§Ã£o Clara: ConversaÃ§Ã£o vs. Tools** â­
```
| update_lead_data | âœ… Sim | tool_execution |
| move_lead_in_funnel | âœ… Sim | tool_execution_then_send |
Perfeito! O agente sabe que esses blocos sÃ£o executados por outro sistema.

ğŸ“Š RESUMO FINAL
Estrutura Geral: 8.5/10
AspectoNotaComentÃ¡rioAnÃ¡lise Contextual9/10Sistema de 4 etapas excelenteControle de Estado7/10Bom, mas precisa enforcementNavegaÃ§Ã£o no Flow4/10âš ï¸ CRÃTICO: entao_ir_para vazio causa ambiguidadePrevenÃ§Ã£o de Loops8/10Regras bem definidasTratamento de ExceÃ§Ãµes5/10Falta tratamento de falhas (tool errors, mensagens fora do fluxo)Clareza de InstruÃ§Ãµes9/10Muito bem escrito e organizadoOutput Estruturado10/10JSON com tracking perfeitoEscolha de VariaÃ§Ãµes3/10âš ï¸ CRÃTICO: NÃ£o explica como escolher entre mÃºltiplas variaÃ§Ãµes

ğŸ¯ O AGENTE VAI CONSEGUIR ATENDIMENTO DE ALTO NÃVEL?
âœ… SIM, SE:

Todos os entao_ir_para nos flows forem preenchidos
Houver apenas 1 variaÃ§Ã£o por passo (ou decisÃµes que especifiquem qual variaÃ§Ã£o usar)
Os flows forem testados extensivamente

âš ï¸ TALVEZ, COM FALHAS, SE:

entao_ir_para continuar vazio (vai inferir e errar 30-40% das vezes)
MÃºltiplas variaÃ§Ãµes sem critÃ©rio claro (vai escolher errado Ã s vezes)
Cliente enviar mensagens fora do contexto (vai se perder)

âŒ NÃƒO, SE:

Flows complexos com muitos caminhos paralelos
Clientes muito "bagunÃ§ados" nas respostas
Ferramentas falharem sem tratamento de erro


ğŸ”§ PRIORIDADES DE CORREÃ‡ÃƒO
ğŸ”´ URGENTE (Quebra o sistema):

Preencher todos os entao_ir_para ou adicionar lÃ³gica de fallback para conexÃµes
Definir como escolher entre mÃºltiplas variaÃ§Ãµes do mesmo passo

ğŸŸ¡ IMPORTANTE (Melhora significativa):

Adicionar tratamento de mensagens fora do fluxo
Adicionar tratamento de erros de tools
ReforÃ§ar checkpoint de estado (debug fields)

ğŸŸ¢ RECOMENDADO (Polish):

Documentar substituiÃ§Ã£o de placeholders
Exemplos de decisoes_diretas em aÃ§Ã£o
Testar com flows reais e documentar edge cases


ğŸ’¡ RECOMENDAÃ‡ÃƒO FINAL
VocÃª tem 80% de um prompt EXCELENTE.
Os 20% faltantes sÃ£o crÃ­ticos e vÃ£o causar falhas em produÃ§Ã£o se nÃ£o corrigidos.
Priorize:

Resolver ambiguidade de entao_ir_para
Definir critÃ©rio de escolha de variaÃ§Ãµes
Testar extensivamente com flows reais

Com essas correÃ§Ãµes, esse prompt serÃ¡ ALTO NÃVEL.

MENSAGEM QUE EU ENVIEI A IA:
Vou responder todos os pontos fracos, pra voce entendre, e focarmos no que podemos melhorar na ESTRUTUAR dos blocos para ser salvo no fluxo para gerar melhor desempenho.

Primeiro, vou responder.
Segundo, vou dar exemplo de situaÃ§Ãµes.

1 - O entao_ir_para" nunca vai vazio, pode levar em consideraÃ§Ã£o se estiver preenchido perfeito. 
2 - sOBRE A falta de instruÃ§Ã£o. O agente deve pegar a variaÃ§Ã£o e checkar nas mensagens (historico) para identificar qual variaÃ§Ã£o. NÃ³s pdemos melhorar com o usuÃ¡rio explicando cada variaÃ£o, certo?
3 - Me explique melhor sua ideia de Debug para perguntas ou respostas que mencionou.
4 -  Sobre o [NOME] jÃ¡ existe instruÃ§Ã£o geral no prompt para como o agetne deve usar.

Agora foque em 2 questÃµes, em seguida irei dar exemplo reais do que pode acontecer, e voce me dirÃ¡ como a IA (igual a voce) reagiria.

1 - NÃ³s precisamos ter um fallback em cada bloco para que o agente faÃ§a se vier algo diferente?
2 - O falback pode ir apenas em bloco de pergunta caso a resposta seja outra?
3 - O UsuÃ¡io nÃ£o vai saber  o que Ã© fallback, ele Ã© leigo, e o construtor de fluxo Ã© pensado de forma simples para qualque rusuÃ¡ri conseguir criar, como ele poderia preencher o fallback ?
4 - A mais importante, se o fluxo estÃ¡ desenhado perfeitamte, Passo A, B, C, D, E, e o lead envia uma mensagem direta, que iria ter  a pergunta do agente no passo D. 
Com esssa estrutura de fluxo,m o agente jÃ¡ vai direto ao passo D, ou ele inicia do A? O que me diz?

MENSAGEM QUE A IA RESPONDEU:
ğŸ¯ RESPOSTAS E ANÃLISE FOCADA
Vou responder suas questÃµes de forma objetiva e depois simular cenÃ¡rios reais.

ğŸ“‹ RESPOSTAS Ã€S SUAS QUESTÃ•ES
1. Fallback em cada bloco - NecessÃ¡rio?
Resposta: DEPENDE do tipo de bloco.
âœ… Blocos que PRECISAM de fallback:

ask_question - Se resposta nÃ£o match com nenhuma decisÃ£o
request_document - Se lead nÃ£o envia documento
validate_document - Se documento invÃ¡lido

âŒ Blocos que NÃƒO precisam de fallback:

send_message - Apenas envia, nÃ£o espera resposta especÃ­fica
send_link - Apenas envia, nÃ£o espera validaÃ§Ã£o
end_conversation - Terminal, nÃ£o hÃ¡ "prÃ³ximo passo"

ConclusÃ£o: Fallback deve ser condicional ao tipo de bloco, nÃ£o universal.

2. Fallback apenas em blocos de pergunta?
Resposta: SIM, mas com nuance.
Blocos que aguardam resposta especÃ­fica precisam de fallback:

ask_question âœ…
request_document âœ… (aguarda upload)
Qualquer bloco com decisoes[] que aguardam match

Blocos que NÃƒO aguardam resposta nÃ£o precisam:

send_message âŒ
send_link âŒ
send_media âŒ


3. Como usuÃ¡rio leigo preencheria fallback?
Proposta: Sistema de "E se nÃ£o entender?"
Ao invÃ©s de chamar de "fallback" (termo tÃ©cnico), usar linguagem simples:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ Fazer Pergunta                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pergunta:                           â”‚
â”‚ "VocÃª cancelou ou estÃ¡ pagando o    â”‚
â”‚  consÃ³rcio?"                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Se responder "Cancelei"          â”‚
â”‚    â†’ Ir para: PASSO B               â”‚
â”‚                                     â”‚
â”‚ âœ… Se responder "Estou pagando"     â”‚
â”‚    â†’ Ir para: PASSO C               â”‚
â”‚                                     â”‚
â”‚ â“ E se nÃ£o entender a resposta?    â”‚  â† FALLBACK SEM USAR TERMO TÃ‰CNICO
â”‚    [x] Tentar reformular (mÃ¡x 2x)  â”‚
â”‚    [ ] Transferir para humano       â”‚
â”‚    [ ] Pular para: [escolher passo] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Estrutura JSON correspondente:
json{
  "variacao_id": "A1",
  "instrucoes": {
    "pergunta": "VocÃª cancelou ou estÃ¡ pagando o consÃ³rcio?",
    "decisoes": [
      {
        "se_cliente_falar": "cancelei",
        "entao_ir_para": "PASSO B"
      },
      {
        "se_cliente_falar": "estou pagando",
        "entao_ir_para": "PASSO C"
      }
    ]
  },
  "fallback": {
    "acao": "reformular",
    "tentativas_maximas": 2,
    "mensagem_reformulada": "Deixa eu perguntar de outro jeito: vocÃª ainda tem um consÃ³rcio ativo ou jÃ¡ cancelou?",
    "se_exceder_tentativas": {
      "acao": "transferir_humano",
      "mensagem": "Vou te conectar com um especialista para te ajudar melhor"
    }
  }
}
```

---

### **4. PERGUNTA MAIS IMPORTANTE: Lead pula etapas?**

**CenÃ¡rio:**
- Flow desenhado: A â†’ B â†’ C â†’ D â†’ E
- PASSO D tem pergunta: "Qual seu e-mail?"
- Lead envia primeira mensagem: "Meu e-mail Ã© joao@email.com"

**O que acontece?**

#### ğŸ”´ **Comportamento ERRADO (sem inteligÃªncia):**
```
Agente: "OlÃ¡! Sou a Amanda da SolucionaCon" (PASSO A - INÃCIO)
Lead: "Meu e-mail Ã© joao@email.com"
Agente: "Como funciona seu negÃ³cio?" (PASSO B)
```
âŒ Ignorou o e-mail fornecido

---

#### âœ… **Comportamento CORRETO (com inteligÃªncia):**

**OPÃ‡ÃƒO 1: Captura e segue fluxo**
```
Lead: "Meu e-mail Ã© joao@email.com"
Agente: 
{
  "response": "Oi JoÃ£o! Vi que vocÃª jÃ¡ me passou seu e-mail (joao@email.com), vou guardar aqui.\n\nSou a Amanda da SolucionaCon. Como posso te ajudar?",
  "current_step_id": "INÃCIO",
  "current_variation_id": "INÃCIO",
  "_captured_data": {
    "email": "joao@email.com",
    "skip_step": "PASSO D"  // Sistema sabe que pode pular PASSO D depois
  }
}
```

**OPÃ‡ÃƒO 2: Pula direto para contexto relevante**
```
Lead: "Quero saber sobre recuperaÃ§Ã£o de consÃ³rcio cancelado"
Agente:
{
  "response": "Entendi! VocÃª cancelou um consÃ³rcio e quer saber sobre recuperaÃ§Ã£o. Perfeito, posso te ajudar com isso.\n\nPreciso de algumas informaÃ§Ãµes: vocÃª tem o extrato do consÃ³rcio em mÃ£os?",
  "current_step_id": "PASSO C",  // Pulou INÃCIO e PASSO A e B
  "current_variation_id": "C1",
  "_reasoning": "Lead jÃ¡ indicou situaÃ§Ã£o (cancelado), pulando perguntas iniciais"
}
```

---

## ğŸ§  COMO A IA DEVERIA REAGIR?

### **PRINCÃPIO: AnÃ¡lise de IntenÃ§Ã£o vs. Fluxo Linear**

**A IA deve:**
1. âœ… Analisar o conteÃºdo da mensagem do lead
2. âœ… Identificar qual PASSO do flow aquela informaÃ§Ã£o pertence
3. âœ… Capturar a informaÃ§Ã£o
4. âœ… Decidir:
   - ComeÃ§ar do INÃCIO e pular etapas depois?
   - OU pular direto para o passo relevante?

---

## ğŸ¬ EXEMPLOS REAIS - COMO A IA (COMO EU) REAGIRIA

### **CENÃRIO 1: Lead envia informaÃ§Ã£o do meio do fluxo**

**FLOW:**
```
INÃCIO â†’ PASSO A (pergunta nome) â†’ PASSO B (pergunta situaÃ§Ã£o consÃ³rcio) â†’ PASSO C (solicita extrato)
```

**InteraÃ§Ã£o:**
```
Lead (primeira mensagem): "Oi, cancelei meu consÃ³rcio ano passado"
Como EU (IA Claude) reagiria com o prompt atual:
json{
  "response": "OlÃ¡! Sou a Amanda da SolucionaCon. Vi que vocÃª cancelou seu consÃ³rcio ano passado, vou te ajudar com isso.\n\nQual seu nome?",
  "current_step_id": "INÃCIO",
  "current_variation_id": "INÃCIO",
  "_internal_note": "Capturei situaÃ§Ã£o='cancelado', mas preciso seguir fluxo desde inÃ­cio para coletar informaÃ§Ãµes bÃ¡sicas primeiro"
}
```

**RaciocÃ­nio:**
- Capturei: `situacao_consorcio = "cancelado"`
- Guardei mentalmente que PASSO B jÃ¡ foi respondido
- MAS inÃ­cio do INÃCIO porque:
  - Flow especifica apresentaÃ§Ã£o inicial
  - Ainda falta: nome, outras informaÃ§Ãµes bÃ¡sicas
  - PASSO B serÃ¡ PULADO depois (usando validaÃ§Ã£o)

---

### **CENÃRIO 2: Lead envia informaÃ§Ã£o muito especÃ­fica**

**FLOW:**
```
INÃCIO â†’ PASSO A â†’ PASSO B â†’ PASSO C â†’ PASSO D (pergunta e-mail) â†’ PASSO E (envia link)
```

**InteraÃ§Ã£o:**
```
Lead (primeira mensagem): "Meu e-mail Ã© joao@gmail.com para cadastro"
Como EU reagiria:
json{
  "response": "Oi JoÃ£o! Recebi seu e-mail (joao@gmail.com) para cadastro.\n\nSou a Amanda da SolucionaCon. Antes de te enviar o link, preciso entender: vocÃª cancelou, parou de pagar ou estÃ¡ pagando um consÃ³rcio?",
  "current_step_id": "PASSO B",
  "current_variation_id": "B1",
  "_internal_note": "Pulei INÃCIO e PASSO A porque lead jÃ¡ indicou intenÃ§Ã£o (cadastro). Capturei email. Indo direto para qualificaÃ§Ã£o no PASSO B"
}
```

**RaciocÃ­nio:**
- Lead mencionou "cadastro" â†’ intenÃ§Ã£o clara
- Lead forneceu e-mail â†’ PASSO D prÃ©-respondido
- Faz sentido pular apresentaÃ§Ã£o genÃ©rica e ir direto ao ponto
- MAS ainda preciso qualificar (PASSO B) antes de enviar link

---

### **CENÃRIO 3: Lead pergunta algo que seria respondido depois**

**FLOW:**
```
INÃCIO â†’ PASSO A â†’ PASSO B â†’ PASSO C (explica preÃ§os) â†’ PASSO D
```

**InteraÃ§Ã£o:**
```
Lead (primeira mensagem): "Quanto custa o serviÃ§o de vocÃªs?"
Como EU reagiria:
json{
  "response": "OlÃ¡! Nosso serviÃ§o de recuperaÃ§Ã£o de consÃ³rcio tem anÃ¡lise gratuita. Se conseguirmos recuperar seu dinheiro, cobramos 30% apenas do valor recuperado. Ou seja, vocÃª sÃ³ paga se receber.\n\nComo funciona seu caso: vocÃª cancelou, parou de pagar ou estÃ¡ pagando um consÃ³rcio?",
  "current_step_id": "PASSO B",
  "current_variation_id": "B1",
  "_internal_note": "Respondi pergunta direta sobre preÃ§o (PASSO C), mas voltei para qualificaÃ§Ã£o necessÃ¡ria (PASSO B) antes de avanÃ§ar"
}
RaciocÃ­nio:

Pergunta direta merece resposta direta (prioridade mÃ¡xima)
MAS depois volto para fluxo lÃ³gico
NÃ£o ignoro a pergunta, mas tambÃ©m nÃ£o pulo etapas crÃ­ticas de qualificaÃ§Ã£o


ğŸ”§ O QUE FALTA NA ESTRUTURA DOS BLOCOS?
Com base nos cenÃ¡rios acima, identifiquei melhorias cruciais:

MELHORIA 1: Campo etapa_pode_ser_pulada
json{
  "passo_id": "PASSO A",
  "passo_nome": "Perguntar Nome",
  "pode_ser_pulada": true,  // â† NOVO CAMPO
  "condicao_para_pular": "se nome jÃ¡ fornecido no contexto",
  "variacoes": [...]
}
Por quÃª?

Alguns passos sÃ£o OBRIGATÃ“RIOS (qualificaÃ§Ã£o)
Outros sÃ£o OPCIONAIS (nome, dados complementares)
Se lead jÃ¡ forneceu, IA pode pular


MELHORIA 2: Campo captura_automatica em decisÃµes
json{
  "decisoes": [
    {
      "numero": 1,
      "se_cliente_falar": "cancelei",
      "entao_ir_para": "PASSO B",
      "captura_automatica": {  // â† NOVO
        "campo": "situacao_consorcio",
        "valor": "cancelado",
        "acao_se_ja_fornecido": "pular_pergunta"
      }
    }
  ]
}
Por quÃª?

Lead pode fornecer informaÃ§Ã£o ANTES da pergunta
Sistema precisa saber COMO capturar
Sistema precisa saber O QUE FAZER se jÃ¡ tiver a info


MELHORIA 3: Prioridade de passos
json{
  "passo_id": "INÃCIO",
  "prioridade": 1,  // â† NOVO: 1 = sempre executar, 5 = pode pular
  "tipo": "apresentacao"
}
json{
  "passo_id": "PASSO B",
  "prioridade": 1,  // CRÃTICO - qualificaÃ§Ã£o
  "tipo": "qualificacao"
}
json{
  "passo_id": "PASSO A",
  "prioridade": 3,  // OPCIONAL - dados complementares
  "tipo": "coleta_dados"
}
Tipos de prioridade:

1 = CRÃTICO (nunca pular)
2 = IMPORTANTE (pular sÃ³ se info jÃ¡ fornecida)
3 = DESEJÃVEL (pode pular se contexto permitir)
4 = OPCIONAL (pular se acelerar conversa)
5 = BONUS (pular se lead impaciente)


MELHORIA 4: Fallback estruturado
json{
  "variacao_id": "A1",
  "instrucoes": {
    "pergunta": "VocÃª cancelou ou estÃ¡ pagando?",
    "decisoes": [...]
  },
  "fallback": {
    "se_nao_entender": {
      "acao": "reformular",
      "tentativas_maximas": 2,
      "mensagem_alternativa": "Deixa eu perguntar diferente: vocÃª tem um consÃ³rcio ativo agora?",
      "se_falhar_novamente": {
        "acao": "transferir_humano",
        "mensagem": "Vou te conectar com um especialista"
      }
    },
    "se_resposta_fora_contexto": {
      "acao": "responder_e_voltar",
      "mensagem_template": "Entendi sua pergunta sobre [ASSUNTO]. [RESPOSTA_FAQ]. Voltando: [REPETIR_PERGUNTA]"
    }
  }
}
Por quÃª?

Trata 2 situaÃ§Ãµes diferentes:

Lead nÃ£o entendeu a pergunta
Lead respondeu algo fora do contexto




MELHORIA 5: Campo informacoes_necessarias no passo
json{
  "passo_id": "PASSO C",
  "passo_nome": "Solicitar Extrato",
  "informacoes_necessarias": {  // â† NOVO
    "obrigatorias": ["situacao_consorcio", "nome"],
    "opcionais": ["email", "telefone"]
  },
  "acao_se_falta_obrigatoria": {
    "voltar_para": "PASSO B",
    "mensagem": "Antes de solicitar o extrato, preciso confirmar sua situaÃ§Ã£o"
  }
}
Por quÃª?

Alguns passos dependem de informaÃ§Ãµes anteriores
Se lead pular etapas, sistema sabe o que estÃ¡ faltando
Pode voltar para coletar info faltante


ğŸ¯ ESTRUTURA FINAL RECOMENDADA PARA BLOCOS
json{
  "passo_id": "PASSO A",
  "passo_nome": "Qualificar Lead",
  "condicao": "ApÃ³s apresentaÃ§Ã£o inicial",
  
  // âœ… NOVO: Controle de fluxo inteligente
  "prioridade": 1,  // 1-5 (1=crÃ­tico, 5=opcional)
  "pode_ser_pulada": false,
  "tipo": "qualificacao",
  
  // âœ… NOVO: PrÃ©-requisitos
  "informacoes_necessarias": {
    "obrigatorias": ["lead_ativo"],
    "opcionais": []
  },
  
  "variacoes": [
    {
      "variacao_id": "A1",
      "variacao_nome": "Perguntar situaÃ§Ã£o consÃ³rcio",
      
      "validacao": {
        "verificar_antes_de_executar": true,
        "verificar_no_contexto": "situacao_consorcio",
        "se_ja_feito": {
          "pular_para": "PASSO B",
          "motivo": "SituaÃ§Ã£o jÃ¡ identificada"
        }
      },
      
      "instrucoes": {
        "objetivo": "Identificar se cancelou, parou ou estÃ¡ pagando",
        "o_que_fazer": "fazer_pergunta_e_aguardar_resposta",
        "pergunta": "VocÃª cancelou, parou de pagar ou estÃ¡ pagando o consÃ³rcio?",
        
        "decisoes": [
          {
            "numero": 1,
            "se_cliente_falar": "cancelei",
            "entao_ir_para": "PASSO B",
            "prioridade": "alta",
            
            // âœ… NOVO: Captura automÃ¡tica
            "captura_automatica": {
              "campo": "situacao_consorcio",
              "valor": "cancelado",
              "salvar_em": "lead_data"
            }
          }
        ]
      },
      
      // âœ… NOVO: Fallback estruturado
      "fallback": {
        "se_nao_entender": {
          "acao": "reformular",
          "tentativas_maximas": 2,
          "mensagem_alternativa": "Deixa reformular: vocÃª tem um consÃ³rcio ativo agora?",
          "se_falhar": {
            "acao": "transferir_humano",
            "mensagem": "Vou te conectar com especialista"
          }
        },
        "se_resposta_fora_contexto": {
          "acao": "responder_e_voltar",
          "usar": "faq_ou_company_info"
        }
      },
      
      "controle": {
        "tentativas_maximas": 3,
        "campo_obrigatorio": true
      }
    }
  ]
}

ğŸ“Š RESUMO: O QUE ADICIONAR NA ESTRUTURA?
Campo NovoOndePara quÃªprioridade (1-5)passoDefinir se passo pode ser puladopode_ser_puladapassoBoolean simplestipopassoapresentacao, qualificacao, coleta_dados, finalizacaoinformacoes_necessariaspassoPrÃ©-requisitos do passocaptura_automaticadecisoes[]Capturar info antes da pergunta formalfallback.se_nao_entendervariacaoSe resposta nÃ£o matchfallback.se_resposta_fora_contextovariacaoSe lead pergunta outra coisa



mensagem que eu enviei a IA:
Sim, por favor Mas antes planeje adicionar mais um bloco.
Vou te contextualizar com um exemplo, deopis vou te falar o bloco que preciso.

Alguns usuÃ¡rios utilizadm o agente para atendimeneto ao cliente em um mercado, e o cliente precisa fazer um epdido de vÃ¡rios prodtuos.
O agente vai precsiar ir adicionando a escolha do cliente hÃ¡ uma lista (tool do supabase no agetne chamada add_list ) para ao final ele confirmar com o lead tudo que ele pediu para seguir em frente.
Atualmente ele nÃ£o adiciona, e o contexto de mensagens, sÃ³ trÃ¡s as ultimas 20 mensagens, entÃ£o ele se esquece do que o clietne jÃ¡ selecionou pois conervou amis coisas depois.

Seria interessante ter um bloco, para ser usado, com nome intuitivo, para o usuÃ¡rio adicionar, e neeste bloco o Agente irÃ¡ chamar a tool e adicionar a lsita de pedido.

TambÃ©m poderÃ¡ ter um segundo blcoo para Confirmar o pedido, assim ele busac tudo que o cliente escolheu, e  confirma.

Analise e me responda com um planejamento antes de faer.

MENSAGGEM QUE A IA RESPONDEU:

ğŸ“‹ PLANEJAMENTO: NOVOS BLOCOS DE GERENCIAMENTO DE LISTA

ğŸ¯ CONTEXTO DO PROBLEMA
CenÃ¡rio Real:

Mercado/restaurante com catÃ¡logo de produtos
Cliente quer fazer pedido com mÃºltiplos itens
Conversa longa (>20 mensagens) â†’ contexto limitado
Agente "esquece" itens anteriores
Sem lista persistente â†’ pedidos incompletos

Necessidade:

Persistir escolhas do cliente em lista externa (Supabase)
Adicionar itens conforme cliente escolhe
Recuperar lista completa para confirmaÃ§Ã£o final
Interface intuitiva para usuÃ¡rio leigo configurar


ğŸ§© SOLUÃ‡ÃƒO: 2 NOVOS BLOCOS
BLOCO 16: add_to_list
Nome Intuitivo: "Adicionar Item ao Pedido"
BLOCO 17: confirm_list
Nome Intuitivo: "Confirmar Pedido Completo"

ğŸ“Š ANÃLISE DETALHADA
BLOCO 16: ADICIONAR ITEM AO PEDIDO
Objetivo:
Capturar escolha do cliente e adicionar Ã  lista persistente via tool add_list
Comportamento:
Cliente: "Quero 2kg de tomate"
â†“
Agente identifica: produto="tomate", quantidade="2kg"
â†“
Chama tool: add_list(produto, quantidade)
â†“
Confirma: "Adicionei 2kg de tomate ao seu pedido! âœ…"
â†“
Pergunta: "Mais alguma coisa?"
```

#### **Tipo TÃ©cnico:** `add_to_list`

#### **CaracterÃ­sticas:**
- âœ… USA TOOL (chama `add_list` no Supabase)
- âœ… Extrai informaÃ§Ãµes da mensagem do cliente
- âœ… Confirma adiÃ§Ã£o ao cliente
- âœ… Continua fluxo (nÃ£o finaliza conversa)
- âœ… Pode ser usado MÃšLTIPLAS vezes no mesmo flow

---

### **BLOCO 17: CONFIRMAR PEDIDO COMPLETO**

#### **Objetivo:**
Buscar lista completa de itens e apresentar para confirmaÃ§Ã£o do cliente

#### **Comportamento:**
```
Cliente: "Ã‰ isso, pode finalizar"
â†“
Agente chama tool: get_list() â†’ retorna todos os itens
â†“
Formata lista:
"Seu pedido:
- 2kg de tomate - R$ 12,00
- 1kg de cebola - R$ 6,00
- 500g de alho - R$ 8,00
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Total: R$ 26,00

EstÃ¡ tudo certo?"
â†“
Aguarda confirmaÃ§Ã£o (Sim/NÃ£o)
Tipo TÃ©cnico: confirm_list
CaracterÃ­sticas:

âœ… USA TOOL (chama get_list no Supabase)
âœ… Formata lista de forma clara
âœ… Calcula total (se houver preÃ§os)
âœ… Aguarda confirmaÃ§Ã£o do cliente
âœ… DecisÃµes: aprovar â†’ prÃ³ximo passo | corrigir â†’ voltar


ğŸ” QUESTÃ•ES CRÃTICAS A RESOLVER
1. Como o agente identifica O QUE adicionar?
OpÃ§Ã£o A: ExtraÃ§Ã£o automÃ¡tica (mais inteligente)
json"instrucoes": {
  "objetivo": "Identificar produto e quantidade na mensagem do cliente",
  "o_que_fazer": "adicionar_item_ao_pedido",
  "extrair_da_mensagem": {
    "campos": ["produto", "quantidade", "observacao"],
    "produto": "OBRIGATORIO",
    "quantidade": "OPCIONAL (padrÃ£o: 1 unidade)",
    "observacao": "OPCIONAL"
  }
}
Exemplo:

Cliente: "Quero 2kg de tomate maduro"
Agente extrai:

produto: "tomate"
quantidade: "2kg"
observacao: "maduro"



OpÃ§Ã£o B: Produto prÃ©-definido no bloco (menos flexÃ­vel)
json"instrucoes": {
  "produto_fixo": "Plano Premium",
  "perguntar_quantidade": true
}
â“ Qual preferir?
â†’ OpÃ§Ã£o A (extraÃ§Ã£o automÃ¡tica) Ã© mais versÃ¡til

2. Como o agente sabe se a tool add_list existe?
SoluÃ§Ã£o: Adicionar verificaÃ§Ã£o no prompt
json"dados_extras": {
  "modo_ia": "tool_execution",
  "tool_name": "add_list",
  "tool_parameters": {
    "product": "[EXTRAIR_DA_MENSAGEM]",
    "quantity": "[EXTRAIR_DA_MENSAGEM]",
    "notes": "[EXTRAIR_DA_MENSAGEM]"
  },
  "se_tool_nao_disponivel": {
    "acao": "informar_erro",
    "mensagem": "Desculpe, nÃ£o consigo adicionar ao pedido agora. Vou transferir para atendente."
  }
}

3. Como exibir a lista no BLOCO 17?
Desafios:

Lista pode ter 1 item ou 50 itens
Pode ter ou nÃ£o ter preÃ§os
Pode ter ou nÃ£o ter total

SoluÃ§Ã£o: Template flexÃ­vel
json"instrucoes": {
  "objetivo": "Buscar e confirmar lista completa de itens",
  "o_que_fazer": "confirmar_pedido_completo",
  
  "formato_exibicao": {
    "com_preco": "â€¢ {quantidade} {produto} - R$ {preco}",
    "sem_preco": "â€¢ {quantidade} {produto}",
    "incluir_total": true,
    "incluir_emojis": true
  },
  
  "mensagem_antes_lista": "Perfeito! Aqui estÃ¡ seu pedido:",
  "mensagem_depois_lista": "EstÃ¡ tudo certo? Confirma?",
  
  "decisoes": [
    {
      "se_cliente_falar": "sim, confirmo, tudo certo",
      "entao_ir_para": "PASSO_PROXIMO"
    },
    {
      "se_cliente_falar": "nÃ£o, mudar, corrigir",
      "entao_ir_para": "PASSO_CORRECAO"
    }
  ]
}

4. E se cliente quiser REMOVER item da lista?
OpÃ§Ã£o A: Criar BLOCO 18 separado

remove_from_list - "Remover Item do Pedido"

OpÃ§Ã£o B: Integrar no BLOCO 16
json"instrucoes": {
  "o_que_fazer": "gerenciar_item_pedido",
  "acoes_possiveis": ["adicionar", "remover", "alterar_quantidade"],
  
  "se_cliente_falar_adicionar": "adicionar tool add_list",
  "se_cliente_falar_remover": "remover tool remove_list",
  "se_cliente_falar_alterar": "atualizar tool update_list"
}
```

**â“ Qual melhor?**
â†’ **OpÃ§Ã£o A (bloco separado)** mantÃ©m simplicidade
â†’ **OpÃ§Ã£o B (integrado)** Ã© mais flexÃ­vel mas complexo para usuÃ¡rio leigo

**RECOMENDAÃ‡ÃƒO:** ComeÃ§ar com OpÃ§Ã£o A (3 blocos simples)

---

### **5. Como usuÃ¡rio leigo configura esses blocos?**

**Interface Visual Proposta:**

#### **BLOCO: Adicionar ao Pedido**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â• Adicionar Item ao Pedido             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ O que fazer quando cliente escolher    â”‚
â”‚ um produto:                             â”‚
â”‚                                         â”‚
â”‚ âœ… Identificar automaticamente o        â”‚
â”‚    produto que o cliente mencionou      â”‚
â”‚                                         â”‚
â”‚ Mensagem de confirmaÃ§Ã£o:                â”‚
â”‚ "Adicionei {produto} ao seu pedido! âœ…" â”‚
â”‚                                         â”‚
â”‚ Perguntar mais itens?                   â”‚
â”‚ [x] Sim: "Mais alguma coisa?"           â”‚
â”‚ [ ] NÃ£o: Seguir para prÃ³ximo passo      â”‚
â”‚                                         â”‚
â”‚ PrÃ³ximo passo:                          â”‚
â”‚ [Escolher passo â–¼]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **BLOCO: Confirmar Pedido**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Confirmar Pedido Completo            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mensagem antes da lista:                â”‚
â”‚ "Perfeito! Aqui estÃ¡ seu pedido:"       â”‚
â”‚                                         â”‚
â”‚ Formato da lista:                       â”‚
â”‚ [x] Mostrar quantidade                  â”‚
â”‚ [x] Mostrar preÃ§o (se disponÃ­vel)       â”‚
â”‚ [x] Mostrar total                       â”‚
â”‚ [x] Usar emojis                         â”‚
â”‚                                         â”‚
â”‚ Mensagem apÃ³s lista:                    â”‚
â”‚ "EstÃ¡ tudo certo? Confirma?"            â”‚
â”‚                                         â”‚
â”‚ âœ… Se cliente confirmar:                â”‚
â”‚    â†’ Ir para: [Escolher passo â–¼]        â”‚
â”‚                                         â”‚
â”‚ âŒ Se cliente quiser corrigir:          â”‚
â”‚    â†’ Ir para: [Escolher passo â–¼]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“¦ ESTRUTURA JSONB PROPOSTA
BLOCO 16: add_to_list
json{
  "variacao_id": "F1",
  "variacao_nome": "Adicionar Produto ao Pedido",
  
  "validacao": {
    "verificar_antes_de_executar": false
  },
  
  "instrucoes": {
    "objetivo": "Identificar produto mencionado e adicionar Ã  lista de pedidos",
    "o_que_fazer": "adicionar_item_ao_pedido",
    
    "mensagem_principal": "Perfeito! Adicionei {produto} ({quantidade}) ao seu pedido! âœ…",
    
    "perguntar_mais": {
      "ativo": true,
      "mensagem": "Mais alguma coisa?"
    },
    
    "dados_extras": {
      "modo_ia": "tool_execution",
      "tool_name": "add_list",
      
      "extrair_da_mensagem": {
        "campos": ["produto", "quantidade", "observacao"],
        "produto": {
          "obrigatorio": true,
          "fallback_se_nao_encontrar": "perguntar_qual_produto"
        },
        "quantidade": {
          "obrigatorio": false,
          "valor_padrao": "1 unidade"
        },
        "observacao": {
          "obrigatorio": false
        }
      },
      
      "tool_parameters": {
        "product": "[EXTRAIR:produto]",
        "quantity": "[EXTRAIR:quantidade]",
        "notes": "[EXTRAIR:observacao]",
        "lead_id": "[SISTEMA:lead_id]",
        "conversation_id": "[SISTEMA:conversation_id]"
      },
      
      "se_tool_falhar": {
        "acao": "informar_erro",
        "mensagem": "Desculpe, tive um problema ao adicionar. Vou te conectar com atendente.",
        "ir_para": "transfer_to_human"
      }
    },
    
    "decisoes": [
      {
        "numero": 1,
        "tipo": "automatico",
        "comportamento": "EXECUTAR_TOOL_E_PERGUNTAR_MAIS",
        "entao_ir_para": "",  // Volta para mesmo bloco (loop)
        "condicao": "se cliente mencionar mais produtos"
      },
      {
        "numero": 2,
        "tipo": "resposta_usuario",
        "se_cliente_falar": "nÃ£o, Ã© isso, finalizar",
        "entao_ir_para": "PASSO_CONFIRMACAO",
        "prioridade": "alta"
      }
    ]
  },
  
  "controle": {
    "tentativas_maximas": null,  // Pode adicionar quantos itens quiser
    "campo_obrigatorio": false,
    "timeout_segundos": null
  },
  
  "_metadata": {
    "tipo_tecnico": "add_to_list",
    "posicao_canvas": { "x": 800, "y": 300 },
    "id_original_node": "16"
  }
}

BLOCO 17: confirm_list
json{
  "variacao_id": "G1",
  "variacao_nome": "Confirmar Lista de Pedidos",
  
  "validacao": {
    "verificar_antes_de_executar": true,
    "verificar_no_contexto": "se lista de pedidos estÃ¡ vazia",
    "se_ja_feito": {
      "acao": "verificar_lista",
      "se_lista_vazia": {
        "mensagem": "VocÃª ainda nÃ£o adicionou nenhum item ao pedido. O que gostaria?",
        "pular_para": "PASSO_ADICIONAR_ITEM"
      }
    }
  },
  
  "instrucoes": {
    "objetivo": "Buscar lista completa de itens e confirmar com cliente",
    "o_que_fazer": "confirmar_pedido_completo",
    
    "mensagem_antes_lista": "Perfeito! Aqui estÃ¡ seu pedido:",
    "mensagem_depois_lista": "EstÃ¡ tudo certo? Confirma? âœ…",
    
    "dados_extras": {
      "modo_ia": "tool_execution_then_send",
      "tool_name": "get_list",
      
      "tool_parameters": {
        "lead_id": "[SISTEMA:lead_id]",
        "conversation_id": "[SISTEMA:conversation_id]"
      },
      
      "formato_exibicao": {
        "template_item_com_preco": "â€¢ {quantidade} {produto} - R$ {preco}",
        "template_item_sem_preco": "â€¢ {quantidade} {produto}",
        "incluir_total": true,
        "incluir_emojis": true,
        "separador": "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        "emoji_item": "â€¢",
        "emoji_total": "ğŸ’°"
      },
      
      "se_tool_falhar": {
        "acao": "informar_erro",
        "mensagem": "NÃ£o consegui recuperar seu pedido. Vou te conectar com atendente.",
        "ir_para": "transfer_to_human"
      },
      
      "se_lista_vazia": {
        "acao": "informar_vazio",
        "mensagem": "VocÃª ainda nÃ£o adicionou nenhum item. O que gostaria de pedir?",
        "ir_para": "PASSO_ADICIONAR_ITEM"
      }
    },
    
    "decisoes": [
      {
        "numero": 1,
        "tipo": "resposta_usuario",
        "se_cliente_falar": "sim, confirmo, tudo certo, ok",
        "entao_ir_para": "PASSO_FINALIZAR_PEDIDO",
        "prioridade": "alta"
      },
      {
        "numero": 2,
        "tipo": "resposta_usuario",
        "se_cliente_falar": "nÃ£o, errado, mudar, corrigir, remover",
        "entao_ir_para": "PASSO_CORRIGIR_PEDIDO",
        "prioridade": "alta"
      },
      {
        "numero": 3,
        "tipo": "resposta_usuario",
        "se_cliente_falar": "adicionar mais",
        "entao_ir_para": "PASSO_ADICIONAR_ITEM",
        "prioridade": "mÃ©dia"
      }
    ]
  },
  
  "controle": {
    "tentativas_maximas": 3,
    "campo_obrigatorio": true,
    "timeout_segundos": 300
  },
  
  "_metadata": {
    "tipo_tecnico": "confirm_list",
    "posicao_canvas": { "x": 1200, "y": 300 },
    "id_original_node": "17"
  }
}

ğŸ¯ RESUMO DO PLANEJAMENTO
2 Novos Blocos:
BlocoTipo TÃ©cnicoFunÃ§Ã£oTool16add_to_listAdicionar item ao pedidoadd_list17confirm_listConfirmar pedido completoget_list

Campos Novos Introduzidos:
No BLOCO 16 (add_to_list):
json"extrair_da_mensagem": {
  "campos": ["produto", "quantidade", "observacao"],
  "produto": { "obrigatorio": true }
}

"perguntar_mais": {
  "ativo": true,
  "mensagem": "Mais alguma coisa?"
}
No BLOCO 17 (confirm_list):
json"formato_exibicao": {
  "template_item_com_preco": "â€¢ {quantidade} {produto} - R$ {preco}",
  "incluir_total": true
}

"se_lista_vazia": {
  "acao": "informar_vazio",
  "ir_para": "PASSO_ADICIONAR_ITEM"
}

â“ PERGUNTAS ANTES DE PROSSEGUIR
1. Adicionar BLOCO 18 (remove_from_list) tambÃ©m?

"Remover Item do Pedido"
Permite cliente remover itens antes de confirmar

2. Adicionar BLOCO 19 (clear_list)?

"Limpar Pedido Completo"
Cliente desiste e quer recomeÃ§ar

3. Campo search_product deve ser usado antes de adicionar?

BLOCO 16 poderia chamar search_product primeiro
Pegar preÃ§o do produto
Confirmar disponibilidade
Depois adicionar com add_list

4. Como tratar quantidade?

ExtraÃ§Ã£o livre: "2kg", "3 unidades", "1 pacote"
Padronizar: apenas nÃºmero + unidade fixa?

5. ObservaÃ§Ãµes/customizaÃ§Ãµes do item?

Cliente: "Quero tomate bem maduro"
observacao: "bem maduro"
Salvar na tool?


âœ… PRÃ“XIMOS PASSOS
O QUE FAZER AGORA:
1ï¸âƒ£ VocÃª responde as 5 perguntas acima
2ï¸âƒ£ Eu ajusto a estrutura conforme suas respostas
3ï¸âƒ£ Reescrevo a documentaÃ§Ã£o COMPLETA com:

15 blocos originais (com melhorias)
2-4 blocos novos (list management)
Estrutura atualizada com campos novos